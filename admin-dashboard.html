<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUILL - Dashboard</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCsk99-24TWqPARmr6UWBBKh_3AE8ibJVo",
          authDomain: "project-management-acde3.firebaseapp.com",
          databaseURL: "https://project-management-acde3-default-rtdb.firebaseio.com",
          projectId: "project-management-acde3",
          storageBucket: "project-management-acde3.appspot.com",
          messagingSenderId: "223881271649",
          appId: "1:223881271649:web:de625e09b8f39388df4d20",
          measurementId: "G-924JZR3M0H",
        }

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Budget Management Functions
        function toggleBudgetEdit() {
            const budgetEditSection = document.getElementById('budgetEditSection');
            const currentBudget = document.getElementById('pd-budget').textContent;
            document.getElementById('currentBudgetDisplay').textContent = currentBudget;
            budgetEditSection.style.display = budgetEditSection.style.display === 'none' ? 'block' : 'none';
        }

        function cancelBudgetEdit() {
            document.getElementById('budgetEditSection').style.display = 'none';
            document.getElementById('budgetAdjustment').value = '';
            document.getElementById('budgetEditMessage').textContent = '';
        }

        function applyBudgetChange() {
            const adjustment = parseFloat(document.getElementById('budgetAdjustment').value);
            const operation = document.getElementById('budgetOperation').value;
            const currentBudget = parseFloat(document.getElementById('pd-budget').textContent.replace(/[^0-9.-]+/g, ''));
            const budgetEditMessage = document.getElementById('budgetEditMessage');
            
            if (isNaN(adjustment) || adjustment <= 0) {
                budgetEditMessage.textContent = 'Please enter a valid amount.';
                budgetEditMessage.style.color = '#d32f2f';
                return;
            }

            let newBudget;
            if (operation === 'add') {
                newBudget = currentBudget + adjustment;
            } else {
                if (adjustment > currentBudget) {
                    budgetEditMessage.textContent = 'Cannot subtract more than the current budget.';
                    budgetEditMessage.style.color = '#d32f2f';
                    return;
                }
                newBudget = currentBudget - adjustment;
            }

            // Get user key (admin-user or current user's UID)
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            const projectId = document.getElementById('projectDetailView').getAttribute('data-project-id');
            
            if (!userKey || !projectId) {
                budgetEditMessage.textContent = 'Error: User or project not found.';
                budgetEditMessage.style.color = '#d32f2f';
                return;
            }

            // Show loading state
            budgetEditMessage.textContent = 'Updating budget...';
            budgetEditMessage.style.color = '#666';

            // Update the budget in Firebase
            const projectRef = firebase.database().ref(`projects/${userKey}/${projectId}`);
            
            // First verify the project exists
            projectRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        throw new Error('Project not found');
                    }
                    return projectRef.update({
                        budget: newBudget,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                })
                .then(() => {
                    // Add to budget history
                    const historyRef = firebase.database().ref(`projects/${userKey}/${projectId}/budgetHistory`).push();
                    return historyRef.set({
                        amount: adjustment,
                        operation: operation,
                        previousBudget: currentBudget,
                        newBudget: newBudget,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        updatedBy: firebase.auth().currentUser?.email || localStorage.getItem('userEmail') || 'Unknown'
                    });
                })
                .then(() => {
                    // Only update UI after all Firebase operations are successful
                    document.getElementById('pd-budget').textContent = `₱${newBudget.toLocaleString()}`;
                    document.getElementById('currentBudgetDisplay').textContent = `₱${newBudget.toLocaleString()}`;
                    budgetEditMessage.textContent = 'Budget updated successfully!';
                    budgetEditMessage.style.color = '#388e3c';
                    
                    // Clear the form
                    document.getElementById('budgetAdjustment').value = '';
                    
                    // Refresh the budget chart
                    loadBudgetLineChart(projectId);
                })
                .catch((error) => {
                    console.error('Error in budget update process:', error);
                    // Check if the budget was actually updated despite the error
                    projectRef.once('value')
                        .then((snapshot) => {
                            const currentBudget = snapshot.val()?.budget;
                            if (currentBudget === newBudget) {
                                // Budget was actually updated successfully
                                document.getElementById('pd-budget').textContent = `₱${newBudget.toLocaleString()}`;
                                document.getElementById('currentBudgetDisplay').textContent = `₱${newBudget.toLocaleString()}`;
                                budgetEditMessage.textContent = 'Budget updated successfully!';
                                budgetEditMessage.style.color = '#388e3c';
                                document.getElementById('budgetAdjustment').value = '';
                                loadBudgetLineChart(projectId);
                            } else {
                                // Show specific error message based on the error type
                                if (error.message === 'Project not found') {
                                    budgetEditMessage.textContent = 'Error: Project not found.';
                                } else if (error.code === 'PERMISSION_DENIED') {
                                    budgetEditMessage.textContent = 'Error: You do not have permission to update this budget.';
                                } else {
                                    budgetEditMessage.textContent = 'Error updating budget. Please try again.';
                                }
                                budgetEditMessage.style.color = '#d32f2f';
                            }
                        });
                });
        }

        // Helper function to get current project ID
        function getCurrentProjectId() {
            // This should return the ID of the currently viewed project
            // You might need to modify this based on how you're tracking the current project
            return window.currentProjectId;
        }

        // Project Creation Trend Chart
        function loadProjectCreationTrendChart() {
            const ctx = document.getElementById('projectCreationTrendChart').getContext('2d');
            const userKey = localStorage.getItem('isAdmin') === 'true' ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            
            if (!userKey) {
                console.error('User not authenticated');
                return;
            }

            // Get all projects
            firebase.database().ref(`projects/${userKey}`).once('value')
                .then((snapshot) => {
                    const projects = snapshot.val() || {};
                    
                    // Create a map to store projects by month
                    const projectsByMonth = {};
                    
                    // Process each project
                    Object.values(projects).forEach(project => {
                        if (project.createdAt) {
                            const date = new Date(project.createdAt);
                            const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            
                            if (!projectsByMonth[monthYear]) {
                                projectsByMonth[monthYear] = 0;
                            }
                            projectsByMonth[monthYear]++;
                        }
                    });

                    // Sort months chronologically
                    const sortedMonths = Object.keys(projectsByMonth).sort();
                    
                    // Prepare data for the chart
                    const labels = sortedMonths.map(month => {
                        const [year, monthNum] = month.split('-');
                        return new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    });
                    
                    const data = sortedMonths.map(month => projectsByMonth[month]);

                    // Create the chart
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Projects Created',
                                data: data,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Project Creation Trend',
                                    font: {
                                        size: 16
                                    }
                                },
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading project creation trend:', error);
                });
        }

        // Call the function when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadProjectCreationTrendChart();
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
        }

        .logo {
            padding: 0 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
        }

        .logo img {
            height: 24px;
            margin-right: 5px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
            color: #333;
            text-decoration: none;
        }

        .nav-item:hover {
            background-color: #f5f5f5;
        }

        .nav-item.active {
            background-color: #f0f0f0;
            border-left: 4px solid #000;
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
        }

        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .welcome-text {
            font-size: 24px;
            font-weight: 500;
            color: #333;
        }

        .content-area {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-user {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0 0 0;
            border-top: 1px solid #eee;
            background: #fff;
        }
        .sidebar-user-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #e0e0e0;
            background-size: cover;
            background-position: center;
            margin-bottom: 10px;
        }
        .sidebar-user-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            text-align: center;
            max-width: 100%;
            padding: 0 10px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-user-email {
            font-size: 12px;
            color: #666;
            text-align: center;
            word-break: break-all;
            max-width: 100%;
            padding: 0 10px;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .logout-btn {
            margin-top: 12px;
            width: 80%;
            padding: 10px;
            background: #fff;
            color: #d32f2f;
            border: 1px solid #d32f2f;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .logout-btn:hover {
            background: #d32f2f;
            color: #fff;
        }

        .sidebar-user-email {
          font-size: 12px;
          color: #666;
          text-align: center;
          word-break: break-all;
          max-width: 100%;
          padding: 0 10px;
          margin-bottom: 10px;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .sidebar-user-name {
          font-size: 14px;
          font-weight: 500;
          color: #333;
          margin-bottom: 4px;
          text-align: center;
          max-width: 100%;
          padding: 0 10px;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dark-mode .loading-spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: #fff;
        }
        
        /* File upload styles */
        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            border-color: #000;
            background-color: #f9f9f9;
        }
        
        .file-upload-input {
            display: none;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .file-item-name {
            flex: 1;
            margin-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-item-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Message styles */
        .message-container {
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .message-header {
            background: #f5f5f5;
            padding: 12px 16px;
            font-weight: 500;
            border-bottom: 1px solid #eee;
        }
        
        .message-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 16px;
        }
        
        .message-item {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }
        
        .message-sender {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .message-text {
            background: #f0f0f0;
            padding: 10px 12px;
            border-radius: 8px;
            display: inline-block;
            max-width: 80%;
        }
        
        .message-time {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        
        .message-input-container {
            display: flex;
            padding: 12px;
            border-top: 1px solid #eee;
        }
        
        .message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        .message-send-btn {
            background: #000;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0 16px;
            cursor: pointer;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .analytics-card h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
    <!-- Add this to ensure the email is visible -->
    <style>
        /* Add this to ensure the email is visible */
        #sidebarUserEmail {
            display: block !important;
            font-size: 12px !important;
            color: #666 !important;
            text-align: center !important;
            padding: 0 10px !important;
            margin-bottom: 10px !important;
            max-width: 100% !important;
            word-break: break-all !important;
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <img src="logopms.png" alt="QUILL" style="height: 40px; margin-right: 10px;">
        </div>
        <ul class="nav-menu">
            <a href="#" class="nav-item active">
                <i class="fas fa-home"></i>
                Dashboard
            </a>
            <a href="#" class="nav-item" id="projectsNav">
                <i class="fas fa-project-diagram"></i>
                Projects
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-cog"></i>
                Settings
            </a>
            <a href="#" class="nav-item" id="membersNav">
                <i class="fas fa-users"></i>
                Company Members
            </a>
            <a href="#" class="nav-item" id="archiveNav">
                <i class="fas fa-archive"></i>
                Archive
            </a>
            <!-- Add to sidebar navigation -->
            <a href="#" class="nav-item" id="recycleBinNav">
                <i class="fas fa-trash-restore"></i>
                Recycle Bin
            </a>
        </ul>
        <div class="sidebar-user" id="sidebarUser">
            <div class="sidebar-user-avatar" id="sidebarUserAvatar"></div>
            <div class="sidebar-user-name" id="sidebarUserName"></div>
            <div class="sidebar-user-email" id="sidebarUserEmail"></div>
            <button class="logout-btn" id="logoutBtn" onclick="logoutUser()">Log out</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="welcome-text">Welcome back!</div>
        </div>
        <div class="content-area">
            <!-- Dashboard Overview Content -->
            <div id="dashboard-content">
                <h2>Dashboard</h2>
                <!-- Tabs -->
                <div style="margin-bottom: 24px;">
                    <button id="overviewTab" class="dashboard-tab-btn" style="padding:8px 24px; border-radius:6px 6px 0 0; border:1px solid #bbb; border-bottom:none; background:#000; color:#fff; font-weight:500;">OVERVIEW</button>
                    <button id="analyticsTab" class="dashboard-tab-btn" style="padding:8px 24px; border-radius:6px 6px 0 0; border:1px solid #bbb; border-bottom:none; background:#fff; color:#000; font-weight:500;">ANALYTICS</button>
                </div>
                <!-- Overview Section -->
                <div id="overview-section">
                    <!-- Dashboard Summary -->
                    <div id="dashboard-summary" style="display: flex; gap: 24px; margin-bottom: 32px;">
                        <div style="flex:1; background:#fff; border:1px solid #bbb; border-radius:12px; padding:24px; text-align:center;">
                            <div style="font-size:20px; font-weight:600; margin-bottom:8px;">Projects</div>
                            <div id="summary-total" style="font-size:36px; font-weight:700;">0</div>
                        </div>
                        <div style="flex:1; background:#fff; border:1px solid #bbb; border-radius:12px; padding:24px; text-align:center;">
                            <div style="font-size:20px; font-weight:600; margin-bottom:8px;">In Progress</div>
                            <div id="summary-inprogress" style="font-size:36px; font-weight:700;">0</div>
                        </div>
                        <div style="flex:1; background:#fff; border:1px solid #bbb; border-radius:12px; padding:24px; text-align:center;">
                            <div style="font-size:20px; font-weight:600; margin-bottom:8px;">Completed</div>
                            <div id="summary-completed" style="font-size:36px; font-weight:700;">0</div>
                        </div>
                    </div>
                    <!-- Dashboard Activities -->
                    <div style="display: flex; gap: 24px;">
                        <div style="flex:1; background:#fff; border:1px solid #bbb; border-radius:12px;">
                            <div style="background:#000; color:#fff; padding:12px 18px; border-radius:12px 12px 0 0; font-size:18px; font-weight:500;">Recent Activities</div>
                            <div id="dashboard-activities" style="padding:18px; min-height:120px; font-size:16px;"></div>
                        </div>
                        <div style="flex:1; background:#fff; border:1px solid #bbb; border-radius:12px;">
                            <div style="background:#000; color:#fff; padding:12px 18px; border-radius:12px 12px 0 0; font-size:18px; font-weight:500;">Project Progress</div>
                            <div id="dashboard-progress" style="padding:18px; min-height:120px; font-size:16px;"></div>
                        </div>
                    </div>
                </div>
                <!-- Analytics Section -->
                <div id="analytics-section" style="display:none;">
                    <h2>Analytics</h2>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3>Project Creation Trend</h3>
                            <div class="chart-container">
                                <canvas id="projectCreationTrendChart"></canvas>
                            </div>
                        </div>
                        <!-- Other analytics cards -->
                    </div>
                </div>
            </div>
            <!-- Projects Section (separate from dashboard) -->
            <div id="projects-content" style="display:none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px;">
                    <h2 style="letter-spacing: 1px;">PROJECTS</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="newProjectBtn" style="background: #000; color: #fff; border: none; border-radius: 4px; padding: 10px 18px; font-size: 15px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <i class="fas fa-plus"></i> New Project
                        </button>
                        <button id="deleteAllProjectsBtn" style="background: #fff; color: #d32f2f; border: 1px solid #d32f2f; border-radius: 4px; padding: 10px 18px; font-size: 15px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <i class="fas fa-trash"></i> Delete All
                        </button>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px;">
                    <input id="projectSearchInput" type="text" placeholder="Search project..." style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; width: 220px;">
                    <button id="projectSearchBtn" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 8px 12px; cursor: pointer;"><i class="fas fa-search"></i></button>
                </div>
                <div style="margin-bottom: 18px;">
                    <button class="proj-filter-btn" data-status="all" style="padding: 7px 18px; border: 1px solid #000; background: #000; color: #fff; border-radius: 4px; margin-right: 6px; cursor: pointer;">All Projects</button>
                    <button class="proj-filter-btn" data-status="active" style="padding: 7px 18px; border: 1px solid #ccc; background: #fff; color: #000; border-radius: 4px; margin-right: 6px; cursor: pointer;">Active</button>
                    <button class="proj-filter-btn" data-status="completed" style="padding: 7px 18px; border: 1px solid #ccc; background: #fff; color: #000; border-radius: 4px; margin-right: 6px; cursor: pointer;">Completed</button>
                </div>
                <div id="projectsCardsContainer" style="display: flex; flex-wrap: wrap; gap: 32px;"></div>
                <div id="projectsEmpty" style="color: #888; margin-top: 12px; display: none;">No projects found.</div>
            </div>

            <!-- Project Detail Section -->
            <div id="projectDetailView" style="display:none;">
                <div style="display: flex; align-items: center; margin-bottom: 24px;">
                    <button onclick="backToProjects()" style="background: none; border: none; font-size: 20px; cursor: pointer; margin-right: 16px;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 id="projectDetailTitle" style="margin: 0; letter-spacing: 1px;">Project Details</h2>
                </div>
                
                <div style="background: #fff; border: 1px solid #bbb; border-radius: 12px; padding: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Project Details -->
                        <div>
                            <h3 style="font-size: 18px; margin-bottom: 16px;">Project Details</h3>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Description</div>
                                <div id="pd-description" style="color: #666;">Project description</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Type</div>
                                <div id="pd-type" style="color: #666;">Project type</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Duration</div>
                                <div id="pd-duration" style="color: #666;">Project duration</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Start Date</div>
                                <div id="pd-date" style="color: #666;">Project date</div>
                            </div>
                        </div>
                        <!-- Additional Information -->
                        <div>
                            <h3 style="font-size: 18px; margin-bottom: 16px;">Additional Information</h3>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Budget</div>
                                <div id="pd-budget" style="color: #666;">Project budget</div>
                                <div id="addBudgetSection" style="display: none; margin-top: 8px;">
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="number" id="newBudgetInput" placeholder="Enter additional budget" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
                                        <button onclick="addNewBudget()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Add Budget</button>
                                    </div>
                                    <div id="addBudgetMsg" class="budget-message" style="font-size: 13px; margin-top: 4px;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Location</div>
                                <div id="pd-location" style="color: #666;">Project location</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Team Leader</div>
                                <div id="pd-leader" style="color: #666;">Project leader</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">Status</div>
                                <div id="pd-status" style="color: #666;">Project status</div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Budget Section -->
                    <div style="margin-top: 24px; border-top: 1px solid #eee; padding-top: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 18px; margin: 0;">Budget Management</h3>
                            <button onclick="toggleBudgetEdit()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-edit"></i> Edit Budget
                            </button>
                        </div>
                        <div id="budgetEditSection" style="display: none; background: #f9f9f9; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Current Budget</label>
                                    <div id="currentBudgetDisplay" style="font-size: 18px; color: #333;"></div>
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Adjustment Amount</label>
                                    <input type="number" id="budgetAdjustment" placeholder="Enter amount" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Operation</label>
                                    <select id="budgetOperation" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="add">Add to Budget</option>
                                        <option value="subtract">Subtract from Budget</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button onclick="applyBudgetChange()" style="flex: 1; padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Apply Changes</button>
                                <button onclick="cancelBudgetEdit()" style="flex: 1; padding: 8px 16px; background: #fff; color: #666; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">Cancel</button>
                            </div>
                            <div id="budgetEditMessage" style="margin-top: 8px; font-size: 14px;"></div>
                        </div>
                    </div>

                    <!-- Tasks Section -->
                    <div style="margin-top: 24px; border-top: 1px solid #eee; padding-top: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 18px; margin: 0;">Tasks</h3>
                            <button onclick="showAddTaskModal()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-plus"></i> Add Task
                            </button>
                        </div>
                        <div id="projectTasksList" style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>

                    <!-- Team Members Section -->
                    <div style="margin-top: 24px; border-top: 1px solid #eee; padding-top: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 18px; margin: 0;">Team Members</h3>
                            <button onclick="showAddTeamMemberModal()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-plus"></i> Add Member
                            </button>
                        </div>
                        <div id="teamMembersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                            <!-- Team members will be loaded here -->
                        </div>
                    </div>

                    <!-- Project Progress -->
                    <div style="margin-top: 24px; border-top: 1px solid #eee; padding-top: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 18px;">Project Progress</h3>
                            <button onclick="generateProjectReport()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-file-alt"></i> Generate Report
                            </button>
                        </div>
                        <div style="background: #eee; border-radius: 4px; height: 8px; width: 100%; margin-bottom: 8px;">
                            <div id="pd-progress-bar" style="background: #000; height: 8px; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="pd-progress" style="font-size: 14px; color: #666;">0%</div>
                        <!-- Add this below the progress bar -->
                        <div id="projectFilesListDetail" style="margin-top: 16px;"></div>
                    </div>

                    <!-- Chat Section -->
                    <div style="margin-top: 24px; border-top: 1px solid #eee; padding-top: 24px;">
                        <h3 style="font-size: 18px; margin-bottom: 16px;">Project Chat</h3>
                        <div id="projectChatMessages" style="max-height: 200px; overflow-y: auto; background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <!-- Chat messages will be loaded here -->
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <input id="projectChatInput" type="text" placeholder="Type a message..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <button onclick="sendProjectChatMessage()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Send</button>
                        </div>
                    </div>
                </div>
                <!-- Add this inside your project detail view/modal, where you want the Budget History table to appear -->
                <div id="budgetHistoryTable" style="margin-top:24px;"></div>
            </div>
            <!-- Messages Section -->
            <div id="messages-content" style="display:none;">
                <h2>Messages</h2>
                <p>Your messages will appear here.</p>
            </div>
            <!-- Settings Section -->
            <div id="settings-content" style="display:none;">
                <h2>Settings</h2>
                <div style="max-width: 420px; margin: 0 auto;">
                    <!-- Profile Picture -->
                    <div style="margin-bottom: 24px;">
                        <label style="font-weight: 500;">Profile Picture</label><br>
                        <input type="file" id="profilePicInput" accept="image/*" style="margin-top: 8px;">
                        <div id="profilePicPreview" style="margin-top: 10px; width: 80px; height: 80px; border-radius: 50%; background: #eee; background-size: cover; background-position: center;"></div>
                        <button id="saveProfilePicBtn" style="margin-top: 10px; padding: 8px 18px; border-radius: 6px; border: none; background: #000; color: #fff; cursor: pointer;">
                            Save Profile Picture
                            <span id="profilePicSpinner" class="loading-spinner" style="display: none;"></span>
                        </button>
                        <div id="saveProfilePicMsg" style="font-size: 13px; color: #388e3c; margin-top: 6px;"></div>
                    </div>
                    <!-- Change Name section -->
                    <div style="margin-bottom: 24px;">
                        <label style="font-weight: 500;">Display Name</label><br>
                        <input type="text" id="displayNameInput" style="margin-top: 8px; padding: 8px; width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                        <button id="saveNameBtn" style="margin-top: 10px; padding: 8px 18px; border-radius: 6px; border: none; background: #000; color: #fff; cursor: pointer;">
                            Save Name
                            <span id="saveNameSpinner" class="loading-spinner" style="display: none;"></span>
                        </button>
                        <div id="saveNameMsg" style="font-size: 13px; color: #388e3c; margin-top: 6px;"></div>
                    </div>

                    <!-- Dark Mode Toggle -->
                    <div style="margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <label style="font-weight: 500;">Dark Mode</label>
                        <label class="switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
            <!-- Company Members Section -->
            <div id="members-content" style="display:none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px;">
                    <h2 style="letter-spacing: 1px;">COMPANY MEMBERS</h2>
                </div>
                <div style="background: #fff; border: 1px solid #bbb; border-radius: 12px; padding: 24px;">
                    <div id="membersList" style="display: grid; gap: 16px;">
                        <!-- Members will be loaded here -->
                    </div>
                </div>
            </div>
            <!-- Archive Section -->
            <div id="archive-content" style="display:none;">
                <h2>Archived Projects</h2>
                <div id="archivedProjectsList" style="display: grid; gap: 24px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));"></div>
                <div id="archiveEmpty" style="color: #888; margin-top: 12px; display: none;">No archived projects found.</div>
            </div>
            <!-- Recycle Bin Section -->
            <div id="recyclebin-content" style="display:none;">
                <h2>Recycle Bin</h2>
                <div id="recycleBinList" style="display: grid; gap: 24px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));"></div>
                <div id="recycleBinEmpty" style="color: #888; margin-top: 12px; display: none;">No deleted projects found.</div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 32px 24px; border-radius: 10px; min-width: 340px; box-shadow: 0 2px 16px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: stretch;">
            <h3 style="margin-bottom: 18px;">Add Project</h3>
            <input id="npName" type="text" placeholder="Project name" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-size: 15px;" />
            <input id="npType" type="text" placeholder="Project type" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-size: 15px;" />
            <textarea id="npDesc" placeholder="Description" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-size: 15px; resize: vertical;"></textarea>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #666;">Start Date</label>
                    <input id="npStartDate" type="date" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;" />
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #666;">End Date</label>
                    <input id="npEndDate" type="date" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;" />
                </div>
            </div>
            <input id="npBudget" type="number" placeholder="Budget" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-size: 15px;" />
            <input id="npLocation" type="text" placeholder="Location" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-size: 15px;" />
            <select id="npLeader" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 18px; font-size: 15px; width: 100%;">
                <option value="">Select Team Leader</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeNewProjectModal()" style="flex:1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer;">Cancel</button>
                <button onclick="submitNewProject()" style="flex:1; padding: 10px; border-radius: 6px; border: none; background: #000; color: #fff; cursor: pointer;">Add Project</button>
            </div>
            <div id="newProjectError" style="color: #d32f2f; font-size: 13px; margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Project Full View Modal -->
    <div id="projectFullViewModal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 32px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 id="pfv-title" style="font-size: 24px; font-weight: 600;">Project Title</h2>
                <button onclick="closeProjectFullView()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
            </div>
            
            <!-- Project Details -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 16px;">Project Details</h3>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Description</div>
                        <div id="pfv-description" style="color: #666;">Project description</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Type</div>
                        <div id="pfv-type" style="color: #666;">Project type</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Duration</div>
                        <div id="pfv-duration" style="color: #666;">Project duration</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Start Date</div>
                        <div id="pfv-date" style="color: #666;">Project date</div>
                    </div>
                </div>
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 16px;">Additional Information</h3>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Budget</div>
                        <div id="pfv-budget" style="color: #666;">Project budget</div>
                        <div id="addBudgetSection" style="display: none; margin-top: 8px;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="newBudgetInput" placeholder="Enter additional budget" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
                                <button onclick="addNewBudget()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Add Budget</button>
                            </div>
                            <div id="addBudgetMsg" class="budget-message" style="font-size: 13px; margin-top: 4px;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Location</div>
                        <div id="pfv-location" style="color: #666;">Project location</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Team Leader</div>
                        <div id="pfv-leader" style="color: #666;">Project leader</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Status</div>
                        <div id="pfv-status" style="color: #666;">Project status</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Progress</div>
                        <div style="background: #eee; border-radius: 4px; height: 8px; width: 100%; margin-bottom: 4px;">
                            <div id="pfv-progress-bar" style="background: #000; height: 8px; border-radius: 4px; width: 0%;"></div>
                        </div>
                        <div id="pfv-progress" style="color: #666;">0%</div>
                    </div>
                </div>
            </div>

            <!-- Team Members Section -->
            <div style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 18px;">Team Members</h3>
                    <button id="addTeamMemberBtn" style="background: #000; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; display: none;">
                        <i class="fas fa-plus"></i> Add Member
                    </button>
                </div>
                <div id="teamMembersList" style="display: grid; gap: 12px;">
                    <!-- Team members will be listed here -->
                </div>
            </div>
            
            <!-- Document Upload Section -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 18px; margin-bottom: 16px;">Documents</h3>
                <div class="file-upload" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <p>Drag & drop files here or click to browse</p>
                    <input type="file" id="fileUploadInput" class="file-upload-input" multiple>
                </div>
                <div id="fileUploadProgress" style="display: none; margin-bottom: 16px;">
                    <div style="font-weight: 500; margin-bottom: 8px;">Uploading...</div>
                    <div style="background: #eee; border-radius: 4px; height: 8px; width: 100%;">
                        <div id="fileProgressBar" style="background: #000; height: 8px; border-radius: 4px; width: 0%;"></div>
                    </div>
                </div>
                <div class="file-list" id="projectFilesList">
                    <!-- Files will be listed here -->
                </div>
            </div>
            
            <!-- Messages Section -->
            <div>
                <h3 style="font-size: 18px; margin-bottom: 16px;">Messages</h3>
                <div class="message-container">
                    <div class="message-header">Project Discussion</div>
                    <div class="message-list" id="projectMessagesList">
                        <!-- Messages will be listed here -->
                    </div>
                    <div class="message-input-container">
                        <input type="text" id="messageInput" class="message-input" placeholder="Type your message...">
                        <button id="sendMessageBtn" class="message-send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 32px; border-radius: 12px; width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 20px; font-weight: 600;">Add New Task</h3>
                <button onclick="closeAddTaskModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Task Title</label>
                <input type="text" id="taskTitleInput" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;" placeholder="Enter task title">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Description</label>
                <textarea id="taskDescription" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; min-height: 100px; resize: vertical;" placeholder="Enter task description"></textarea>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Due Date</label>
                <input type="date" id="taskDueDate" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Assign To</label>
                <select id="taskAssignee" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;">
                    <option value="">Select team member...</option>
                </select>
            </div>
            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Priority</label>
                <select id="taskPriority" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px;">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeAddTaskModal()" style="padding: 10px 20px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer;">Cancel</button>
                <button onclick="submitNewTask()" style="padding: 10px 20px; border: none; border-radius: 6px; background: #000; color: #fff; cursor: pointer;">Add Task</button>
            </div>
            <div id="addTaskError" style="color: #d32f2f; font-size: 13px; margin-top: 12px;"></div>
        </div>
    </div>

    <!-- Project Report Modal -->
    <div id="projectReportModal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 32px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 600;">Project Report</h2>
                <button onclick="closeProjectReportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
            </div>
            
            <div id="projectReportContent"> 
                <!-- Report content will be generated here -->
            </div>
            
            <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="closeProjectReportModal()" style="padding: 8px 16px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">Close</button>
                <button onclick="downloadProjectReport()" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-download"></i> Download PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Archive Project View Modal -->
    <div id="archiveProjectViewModal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 32px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 id="archiveProjectTitle" style="font-size: 24px; font-weight: 600;">Project Title</h2>
                <button onclick="closeArchiveProjectViewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
            </div>
            <div id="archiveProjectDetails">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Add this at the beginning of your script section
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize New Project button
            const newProjectBtn = document.getElementById('newProjectBtn');
            if (newProjectBtn) {
                newProjectBtn.addEventListener('click', function() {
                    document.getElementById('newProjectModal').style.display = 'flex';
                    // Clear form
                    document.getElementById('npName').value = '';
                    document.getElementById('npType').value = '';
                    document.getElementById('npDesc').value = '';
                    document.getElementById('npStartDate').value = '';
                    document.getElementById('npEndDate').value = '';
                    document.getElementById('npBudget').value = '';
                    document.getElementById('npLocation').value = '';
                    document.getElementById('npLeader').value = '';
                    document.getElementById('newProjectError').textContent = '';
                    // Load team leaders
                    loadTeamLeaders();
                });
            }

            // Initialize form submission
            const projectForm = document.getElementById('newProjectModal');
            if (projectForm) {
                const submitBtn = projectForm.querySelector('button[onclick="submitNewProject()"]');
                if (submitBtn) {
                    submitBtn.onclick = submitNewProject;
                }
            }

            // Initialize close button
            const closeBtn = projectForm.querySelector('button[onclick="closeNewProjectModal()"]');
            if (closeBtn) {
                closeBtn.onclick = closeNewProjectModal;
            }
            
            // Initialize file upload area
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileUploadInput = document.getElementById('fileUploadInput');
            
            if (fileUploadArea && fileUploadInput) {
                fileUploadArea.addEventListener('click', function() {
                    fileUploadInput.click();
                });
                
                fileUploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#000';
                    this.style.backgroundColor = '#f9f9f9';
                });
                
                fileUploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#ccc';
                    this.style.backgroundColor = '';
                });
                
                fileUploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#ccc';
                    this.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files.length > 0) {
                        fileUploadInput.files = e.dataTransfer.files;
                        handleFileUpload(e.dataTransfer.files);
                    }
                });
                
                fileUploadInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        handleFileUpload(this.files);
                    }
                });
            }
            
            // Initialize send message button
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendMessageBtn && messageInput) {
                sendMessageBtn.addEventListener('click', function() {
                    sendProjectMessage();
                });
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendProjectMessage();
                    }
                });
            }

            const deleteAllBtn = document.getElementById('deleteAllProjectsBtn');
            if (deleteAllBtn) {
                deleteAllBtn.addEventListener('click', function() {
                    if (!confirm('Are you sure you want to delete ALL your projects? This cannot be undone.')) return;
                    // Get user key
                    const email = document.getElementById('sidebarUserEmail').textContent;
                    getUserKeyByEmail(email, function(userKey) {
                        if (!userKey) {
                            alert('User not found.');
                            return;
                        }
                        if (!(window.firebase && firebase.database)) {
                            alert('Firebase is not initialized');
                            return;
                        }
                        // Remove all projects for this user
                        firebase.database().ref('projects/' + userKey).remove()
                            .then(() => {
                                // Optionally, also remove related project_documents and project_messages if needed
                                // firebase.database().ref('project_documents/' + userKey).remove();
                                // firebase.database().ref('project_messages/' + userKey).remove();
                                fetchAndRenderProjects(userKey);
                                updateDashboardSummary();
                                alert('All projects deleted successfully.');
                            })
                            .catch(error => {
                                console.error('Error deleting all projects:', error);
                                alert('Error deleting all projects: ' + error.message);
                            });
                    });
                });
            }
        });

        // Add click event listeners to menu items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                // Remove active class from all items
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                // Add active class to clicked item
                this.classList.add('active');
                // Show/hide content based on menu item
                const menuItem = this.textContent.trim();
                document.getElementById('dashboard-content').style.display = 'none';
                document.getElementById('projects-content').style.display = 'none';
                document.getElementById('messages-content').style.display = 'none';
                document.getElementById('settings-content').style.display = 'none';
                document.getElementById('members-content').style.display = 'none';
                document.getElementById('archive-content').style.display = 'none';
                document.getElementById('recyclebin-content').style.display = 'none';
                if (menuItem === 'Dashboard') {
                    document.getElementById('dashboard-content').style.display = '';
                } else if (menuItem === 'Projects') {
                    document.getElementById('projects-content').style.display = '';
                    if (typeof loadProjectsForCurrentUser === 'function') {
                        loadProjectsForCurrentUser();
                    }
                } else if (menuItem === 'Messages') {
                    document.getElementById('messages-content').style.display = '';
                } else if (menuItem === 'Settings') {
                    document.getElementById('settings-content').style.display = '';
                } else if (menuItem === 'Company Members') {
                    document.getElementById('members-content').style.display = '';
                    loadCompanyMembers();
                } else if (menuItem === 'Archive') {
                    document.getElementById('archive-content').style.display = '';
                    loadArchivedProjects();
                } else if (menuItem === 'Recycle Bin') {
                    document.getElementById('recyclebin-content').style.display = '';
                    loadRecycleBin();
                }
                console.log(`Selected menu item: ${menuItem}`);
            });
        });

        // User info display logic
        function renderSidebarUser() {
            console.log("Starting renderSidebarUser function");
            
            // Check if user is admin
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (isAdmin) {
                console.log("Admin user detected");
                const nameElement = document.getElementById('sidebarUserName');
                const emailElement = document.getElementById('sidebarUserEmail');
                
                nameElement.textContent = 'Admin';
                emailElement.textContent = 'admin@quill.com';
                
                // Set default admin avatar
                const avatarDiv = document.getElementById('sidebarUserAvatar');
                avatarDiv.innerHTML = `<svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="28" cy="28" r="28" fill="#e0e0e0"/><path d="M28 29c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7 3.582 7 8 7zm0 2c-5.33 0-16 2.686-16 8v3h32v-3c0-5.314-10.67-8-16-8z" fill="#bdbdbd"/></svg>`;
                
                // Try to get profile picture from localStorage
                const photoURL = localStorage.getItem('userPhotoURL');
                if (photoURL) {
                    avatarDiv.style.backgroundImage = `url('${photoURL}')`;
                    avatarDiv.innerHTML = '';
                }
                
                return;
            }
            
            // Regular user flow - keep the existing code
            // Try to get user info from Firebase Auth
            let user = null;
            if (window.firebase && firebase.auth().currentUser) {
                user = firebase.auth().currentUser;
                console.log("Firebase Auth user found:", user.email);
            }
            
            // Fallback: try to get from localStorage (for email/OTP login)
            let email = '';
            let photoURL = '';
            let uid = '';
            let displayName = '';
            
            if (user) {
                email = user.email || '';
                photoURL = user.photoURL || '';
                uid = user.uid;
                displayName = user.displayName || '';
                console.log("User data from Firebase Auth:", { email, uid, displayName });
                
                // Store email in localStorage as backup
                if (email) {
                    localStorage.setItem('userEmail', email);
                }
            } else {
                // Try to get email from localStorage (multiple sources)
                email = localStorage.getItem('tempEmail') || localStorage.getItem('userEmail') || '';
                console.log("Email from localStorage:", email);
            }
            
            // Set avatar (default if missing)
            const avatarDiv = document.getElementById('sidebarUserAvatar');
            if (photoURL) {
                avatarDiv.style.backgroundImage = `url('${photoURL}')`;
            } else {
                // Default avatar (SVG)
                avatarDiv.innerHTML = `<svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="28" cy="28" r="28" fill="#e0e0e0"/><path d="M28 29c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7 3.582 7 8 7zm0 2c-5.33 0-16 2.686-16 8v3h32v-3c0-5.314-10.67-8-16-8z" fill="#bdbdbd"/></svg>`;
            }

            // Try to get profile picture from localStorage if not available from Firebase
            if (!photoURL) {
                photoURL = localStorage.getItem('userPhotoURL');
                if (photoURL) {
                    avatarDiv.style.backgroundImage = `url('${photoURL}')`;
                    avatarDiv.innerHTML = '';
                }
            }

            // Get name and email elements
            const nameElement = document.getElementById('sidebarUserName');
            const emailElement = document.getElementById('sidebarUserEmail');

            // Check if user is admin
            
            
            // Set name to "Admin" if user is admin, otherwise use display name or email
            if (isAdmin) {
                const adminName = localStorage.getItem('adminName') || 'Admin';
                nameElement.textContent = adminName;
            } else {
                // Try to get name from localStorage if not available from Firebase
                if (!displayName) {
                    displayName = localStorage.getItem('userName');
                }
                if (displayName) {
                    nameElement.textContent = displayName;
                } else {
                    nameElement.textContent = email.split('@')[0];
                }
            }
            
            // Make sure the email element is visible and styled properly
            if (emailElement) {
                emailElement.style.display = 'block';
                emailElement.style.fontSize = '12px';
                emailElement.style.color = '#666';
                emailElement.style.textAlign = 'center';
                emailElement.style.padding = '0 10px';
                emailElement.style.marginBottom = '10px';
                emailElement.style.maxWidth = '100%';
                emailElement.style.wordBreak = 'break-all';
            }
            
            // Always set email immediately if we have it
            if (email && emailElement) {
                emailElement.textContent = email;
                console.log("Email set immediately:", email);
            }
            
            if (uid && window.firebase && firebase.database) {
                console.log("Fetching user data from Firebase database for UID:", uid);
                // Try to get user data from Firebase database
                firebase.database().ref('users/' + uid).once('value')
                  .then((snapshot) => {
                    const userData = snapshot.val();
                    console.log("User data from Firebase database:", userData);
                    
                    if (userData) {
                        // If we have user data in the database
                        if (!isAdmin) {  // Only update name if not admin
                            if (userData.name) {
                                nameElement.textContent = userData.name;
                            } else if (displayName) {
                                nameElement.textContent = displayName;
                            } else {
                                // If no name is available, use the first part of the email
                                nameElement.textContent = email.split('@')[0];
                            }
                        }
                        
                        // Always show email in the email element - prioritize the email from Firebase database
                        if (userData.email) {
                            console.log("Setting email from database:", userData.email);
                            emailElement.textContent = userData.email;
                            localStorage.setItem('userEmail', userData.email); // Store for future sessions
                        } else {
                            console.log("No email in database, using auth email:", email);
                            emailElement.textContent = email;
                        }
                    } else {
                        // If no user data in database
                        console.log("No user data in database, using auth data");
                        if (!isAdmin) {  // Only update name if not admin
                            if (displayName) {
                                nameElement.textContent = displayName;
                            } else {
                                nameElement.textContent = email.split('@')[0];
                            }
                        }
                        emailElement.textContent = email;
                        
                        // Create user data if it doesn't exist
                        if (uid && email) {
                            firebase.database().ref('users/' + uid).set({
                                email: email,
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            });
                        }
                    }
                    
                    console.log("Final email displayed:", emailElement.textContent);
                  })
                  .catch((error) => {
                    console.error("Error fetching user data:", error);
                    // Fallback if database fetch fails
                    if (!isAdmin) {  // Only update name if not admin
                        if (displayName) {
                            nameElement.textContent = displayName;
                        } else {
                            nameElement.textContent = email.split('@')[0];
                        }
                    }
                    emailElement.textContent = email;
                    console.log("Email set after error:", email);
                  });
            } else {
                console.log("No Firebase database or UID, using basic data");
                // If no Firebase auth or database
                if (!isAdmin) {  // Only update name if not admin
                    if (displayName) {
                        nameElement.textContent = displayName;
                    } else {
                        // Use first part of email as name if no display name
                        nameElement.textContent = email.split('@')[0];
                    }
                }
                emailElement.textContent = email;
                console.log("Email set (no Firebase):", email);
            }
        }
        // Add this function to directly set the email in the sidebar
        function setEmailDirectly() {
            console.log("Setting email directly");
            
            // Try to get the email from multiple sources
            let email = '';
            
            // 1. Try Firebase Auth
            if (window.firebase && firebase.auth && firebase.auth().currentUser) {
                const user = firebase.auth().currentUser;
                email = user.email || '';
                console.log("Email from Firebase Auth:", email);
                
                // Store in localStorage for persistence
                if (email) {
                    localStorage.setItem('userEmail', email);
                }
                
                // 2. Try Firebase Database
                if (user.uid && firebase.database) {
                    firebase.database().ref('users/' + user.uid).once('value')
                      .then(snapshot => {
                        const userData = snapshot.val();
                        if (userData && userData.email) {
                            email = userData.email;
                            console.log("Email from Firebase Database:", email);
                            document.getElementById('sidebarUserEmail').textContent = email;
                            document.getElementById('sidebarUserEmail').style.display = 'block';
                            localStorage.setItem('userEmail', email);
                        } else if (email) {
                            // Create user data if it doesn't exist
                            firebase.database().ref('users/' + user.uid).set({
                                email: email,
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            });
                        }
                      })
                      .catch(err => {
                        console.error("Error getting user data:", err);
                      });
                }
            }
            
            // 3. Try localStorage (multiple sources)
            if (!email) {
                email = localStorage.getItem('tempEmail') || localStorage.getItem('userEmail') || '';
                console.log("Email from localStorage:", email);
            }
            
            // Set the email if we have one
            if (email) {
                document.getElementById('sidebarUserEmail').textContent = email;
                document.getElementById('sidebarUserEmail').style.display = 'block';
            }
        }

        // Find the logoutUser function and update it:

        function logoutUser() {
            // Save email before logout for potential use in next session
            const currentEmail = document.getElementById('sidebarUserEmail').textContent;
            if (currentEmail) {
                localStorage.setItem('lastLoggedInEmail', currentEmail);
            }
            
            // Firebase sign out if available
            if (window.firebase && firebase.auth) {
                firebase.auth().signOut();
            }
            
            // Remove localStorage items but keep lastLoggedInEmail
            localStorage.removeItem('tempEmail');
            localStorage.removeItem('tempOTP');
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('tempPhone');
            
            // Redirect to login page
            window.location.href = 'index2.html';
        }

        // Add this code at the end of the DOMContentLoaded event listener:

        window.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Add this to ensure email is displayed even if Firebase is slow to initialize
            const lastEmail = localStorage.getItem('lastLoggedInEmail') || localStorage.getItem('userEmail') || localStorage.getItem('tempEmail');
            if (lastEmail && document.getElementById('sidebarUserEmail')) {
                document.getElementById('sidebarUserEmail').textContent = lastEmail;
                document.getElementById('sidebarUserEmail').style.display = 'block';
            }
        });

        // Log out function
        function logoutUser() {
            // Firebase sign out if available
            if (window.firebase && firebase.auth) {
                firebase.auth().signOut();
            }
            // Remove localStorage items
            localStorage.removeItem('tempEmail');
            localStorage.removeItem('tempOTP');
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('tempPhone');
            // Redirect to login page
            window.location.href = 'index2.html';
        }

        // Add a function to load user data for projects that ensures we're using the correct email from Firebase
        function loadProjectsForCurrentUser() {
            // Check if user is admin
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (isAdmin) {
                console.log('Admin user detected, loading projects');
                document.getElementById('sidebarUserName').textContent = 'Admin';
                document.getElementById('sidebarUserEmail').textContent = 'admin@quill.com';
                
                getUserKeyByEmail('admin@quill.com', function(userKey) {
                    fetchAndRenderProjects(userKey);
                    updateDashboardSummary();
                });
                return;
            }
            
            // Regular user flow
            if (window.firebase && firebase.auth && firebase.auth().currentUser) {
                const user = firebase.auth().currentUser;
                const uid = user.uid;
                
                // Get the user data from Firebase to ensure we have the correct email
                firebase.database().ref('users/' + uid).once('value')
                  .then((snapshot) => {
                    const userData = snapshot.val();
                    const email = userData && userData.email ? userData.email : user.email || '';
                    
                    // Update the sidebar email display
                    document.getElementById('sidebarUserEmail').textContent = email;
                    
                    // Now fetch projects using this email
                    getUserKeyByEmail(email, function(userKey) {
                      fetchAndRenderProjects(userKey);
                      updateDashboardSummary();
                    });
                  })
                  .catch((error) => {
                    console.error("Error fetching user data:", error);
                    // Fallback to auth email
                    const email = user.email || '';
                    document.getElementById('sidebarUserEmail').textContent = email;
                    
                    getUserKeyByEmail(email, function(userKey) {
                      fetchAndRenderProjects(userKey);
                      updateDashboardSummary();
                    });
                  });
            } else {
                // Try to use email from localStorage as fallback
                const email = localStorage.getItem('tempEmail') || '';
                document.getElementById('sidebarUserEmail').textContent = email;
                
                if (email) {
                  getUserKeyByEmail(email, function(userKey) {
                    fetchAndRenderProjects(userKey);
                    updateDashboardSummary();
                  });
                }
            }
        }

        // Initial load: show dashboard, hide others
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('dashboard-content').style.display = '';
            document.getElementById('projects-content').style.display = 'none';
            document.getElementById('messages-content').style.display = 'none';
            document.getElementById('settings-content').style.display = 'none';
            
            // Add this to ensure we load user data after Firebase is initialized
            if (window.firebase && firebase.auth) {
              firebase.auth().onAuthStateChanged(function(user) {
                renderSidebarUser();
                setTimeout(loadProjectsForCurrentUser, 500); // Wait for Firebase to be fully ready
              });
            } else {
              renderSidebarUser();
              setTimeout(loadProjectsForCurrentUser, 500);
            }
        });

        // --- Projects Section Logic ---
        // ... keep getUserKeyByEmail ...
        function fetchAndRenderProjects(userKey, filterPriority = 'all', searchTerm = '', statusFilter = 'all') {
            const cardsContainer = document.getElementById('projectsCardsContainer');
            const projectsEmpty = document.getElementById('projectsEmpty');
            cardsContainer.innerHTML = '';
            projectsEmpty.style.display = 'none';

            if (!userKey || !(window.firebase && firebase.database)) {
                projectsEmpty.textContent = 'No projects found.';
                projectsEmpty.style.display = 'block';
                return;
            }

            firebase.database().ref('projects/' + userKey).once('value')
                .then(snapshot => {
                    const projects = [];
                    snapshot.forEach(childSnap => {
                        const project = childSnap.val();
                        project._id = childSnap.key;
                        // Only include non-archived projects
                        if (!project.archived) {
                            projects.push(project);
                        }
                    });

                    // Filter by priority
                    let filtered = filterPriority === 'all' ? projects : projects.filter(p => (p.priority || 'low') === filterPriority);
                    // Filter by status
                    filtered = statusFilter === 'all' ? filtered : filtered.filter(p => (p.status || 'active') === statusFilter);
                    // Filter by search
                    if (searchTerm) {
                        filtered = filtered.filter(p => (p.name || '').toLowerCase().includes(searchTerm.toLowerCase()));
                    }

                    if (filtered.length === 0) {
                        projectsEmpty.textContent = 'No projects found.';
                        projectsEmpty.style.display = 'block';
                    } else {
                        filtered.forEach(project => {
                            const card = document.createElement('div');
                            card.style.width = '270px';
                            card.style.background = '#fff';
                            card.style.border = '1px solid #ddd';
                            card.style.borderRadius = '8px';
                            card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
                            card.style.padding = '20px 18px 18px 18px';
                            card.style.display = 'flex';
                            card.style.flexDirection = 'column';
                            card.style.justifyContent = 'space-between';
                            card.style.cursor = 'pointer';
                            card.onclick = () => showProjectFullView(project);

                            card.innerHTML = `
                                <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${project.name || 'Untitled Project'}</div>
                                    <div style="font-size: 18px; cursor: pointer; color: #888;">&#8942;</div>
                                </div>
                                <div style="font-size: 13px; color: #444; margin-bottom: 10px; min-height: 38px;">${project.description || ''}</div>
                                <div style="font-size: 13px; color: #888; margin-bottom: 6px;">
                                    <span style="margin-right: 10px;"><b>${project.status || 'In Progress'}</b></span>
                                    <i class="fas fa-clock"></i> ${project.date ? new Date(project.date).toLocaleDateString() : ''}
                                </div>
                                <div style="font-size: 13px; color: #888; margin-bottom: 6px;">
                                    <b>Type:</b> ${project.type || ''} &nbsp; <b>Duration:</b> ${project.duration || ''}
                                </div>
                                <div style="font-size: 13px; color: #888; margin-bottom: 6px;">
                                    <b>Budget:</b> ${project.budget ? '₱' + project.budget : ''} &nbsp; <b>Location:</b> ${project.location || ''}
                                </div>
                                <div style="font-size: 13px; color: #888; margin-bottom: 6px;">
                                    <b>Team Leader:</b> ${project.leader || ''}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <div style="font-size: 13px; color: #222; margin-bottom: 2px;">Progress</div>
                                    <div style="background: #eee; border-radius: 4px; height: 8px; width: 100%;">
                                        <div style="background: #000; height: 8px; border-radius: 4px; width: ${project.progress || 0}%; transition: width 0.3s;"></div>
                                    </div>
                                    <div style="font-size: 13px; color: #222; margin-top: 2px;">${project.progress || 0}%</div>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <span style="font-size: 18px;">👤👤👤👤</span>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="event.stopPropagation(); deleteProject('${project._id}', '${userKey}')" style="background: #fff; border: 1px solid #d32f2f; color: #d32f2f; border-radius: 4px; padding: 5px 16px; font-size: 14px; cursor: pointer;">DELETE</button>
                                        <button style="background: #fff; border: 1px solid #000; border-radius: 4px; padding: 5px 16px; font-size: 14px; cursor: pointer;">VIEW</button>
                                    </div>
                                </div>
                            `;
                            cardsContainer.appendChild(card);
                        });
                    }
                })
                .catch(err => {
                    console.error('Error fetching projects:', err);
                    projectsEmpty.textContent = 'No projects found.';
                    projectsEmpty.style.display = 'block';
                });
        }
        // ... keep getUserKeyByEmail ...
        // Filter and search events
        document.querySelectorAll('.proj-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.proj-filter-btn').forEach(b => {
                    b.style.background = '#fff';
                    b.style.color = '#000';
                    b.style.border = '1px solid #ccc';
                });
                this.style.background = '#000';
                this.style.color = '#fff';
                this.style.border = '1px solid #000';
                const status = this.getAttribute('data-status');
                const email = document.getElementById('sidebarUserEmail').textContent;
                getUserKeyByEmail(email, function(userKey) {
                    fetchAndRenderProjects(userKey, 'all', document.getElementById('projectSearchInput').value, status);
                });
            });
        });
        document.getElementById('projectSearchBtn').onclick = function() {
            const searchTerm = document.getElementById('projectSearchInput').value;
            const email = document.getElementById('sidebarUserEmail').textContent;
            getUserKeyByEmail(email, function(userKey) {
                fetchAndRenderProjects(userKey, 'all', searchTerm);
            });
        };
        // Modal logic
        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
            // Clear form
            document.getElementById('npName').value = '';
            document.getElementById('npType').value = '';
            document.getElementById('npDesc').value = '';
            document.getElementById('npStartDate').value = '';
            document.getElementById('npEndDate').value = '';
            document.getElementById('npBudget').value = '';
            document.getElementById('npLocation').value = '';
            document.getElementById('npLeader').value = '';
            document.getElementById('newProjectError').textContent = '';
        }
        
        // Close project full view modal
        function closeProjectFullView() {
            document.getElementById('projectFullViewModal').style.display = 'none';
        }
        
        // Add this function before submitNewProject
        function getUserKeyByEmail(email, callback) {
            if (!(window.firebase && firebase.database)) {
                console.error('Firebase not initialized');
                callback(null);
                return;
            }

            // Check if user is admin
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (isAdmin) {
                console.log('Admin user detected');
                
                // For admin users, we'll use a fixed admin ID
                const adminId = 'admin-user';
                
                // Ensure admin user exists in database
                firebase.database().ref('users/' + adminId).once('value')
                    .then((snapshot) => {
                        if (!snapshot.exists()) {
                            // Create admin user if doesn't exist
                            return firebase.database().ref('users/' + adminId).set({
                                email: 'admin@quill.com',
                                name: 'Admin',
                                isAdmin: true,
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            }).then(() => adminId);
                        }
                        return adminId;
                    })
                    .then((userKey) => {
                        console.log('Admin user key confirmed:', userKey);
                        callback(userKey);
                    })
                    .catch((error) => {
                        console.error('Error ensuring admin user exists:', error);
                        callback(null);
                    });
                return;
            }

            // For regular users, continue with the original logic
            // Get current Firebase Auth user
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.error('No Firebase Auth user found');
                callback(null);
                return;
            }

            const uid = currentUser.uid;
            console.log('Using Firebase Auth UID:', uid);

            // Ensure user exists in database
            const userRef = firebase.database().ref('users/' + uid);
            userRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        // Create user if doesn't exist
                        return userRef.set({
                            email: email,
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        }).then(() => uid);
                    }
                    return uid;
                })
                .then((userKey) => {
                    console.log('User key confirmed:', userKey);
                    callback(userKey);
                })
                .catch((error) => {
                    console.error('Error ensuring user exists:', error);
                    callback(null);
                });
        }

        // Add delete project function
        function deleteProject(projectId, userKey) {
            if (!confirm('Are you sure you want to delete this project?')) {
                return;
            }
            if (!(window.firebase && firebase.database)) {
                alert('Firebase is not initialized');
                return;
            }
            // Move project to recycle_bin before deleting
            const projectRef = firebase.database().ref(`projects/${userKey}/${projectId}`);
            projectRef.once('value').then(snapshot => {
                const projectData = snapshot.val();
                if (!projectData) {
                    alert('Project not found.');
                    return;
                }
                // Add a deletedAt timestamp
                projectData.deletedAt = Date.now();
                firebase.database().ref(`recycle_bin/${userKey}/${projectId}`).set(projectData)
                    .then(() => {
                        // Now remove from projects
                        return projectRef.remove();
                    })
                    .then(() => {
                        fetchAndRenderProjects(userKey);
                        updateDashboardSummary();
                        alert('Project moved to Recycle Bin.');
                    })
                    .catch(error => {
                        alert('Error moving project to Recycle Bin: ' + error.message);
                    });
            });
        }

        // Modify submitNewProject to check for duplicates
        function submitNewProject() {
            var name = document.getElementById('npName').value.trim();
            var type = document.getElementById('npType').value.trim();
            var description = document.getElementById('npDesc').value.trim();
            var startDate = document.getElementById('npStartDate').value;
            var endDate = document.getElementById('npEndDate').value;
            var budget = document.getElementById('npBudget').value.trim();
            var location = document.getElementById('npLocation').value.trim();
            var leader = document.getElementById('npLeader').value.trim();

            // Validate name specifically
            if (!name) {
                document.getElementById('newProjectError').textContent = 'Project name is required.';
                return;
            }

            if (!type || !description || !startDate || !endDate || !budget || !location || !leader) {
                document.getElementById('newProjectError').textContent = 'All fields are required.';
                return;
            }

            // Validate dates
            if (new Date(startDate) > new Date(endDate)) {
                document.getElementById('newProjectError').textContent = 'End date must be after start date.';
                return;
            }

            // Get current user's email or use admin email if admin
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const email = isAdmin ? 'admin@quill.com' : document.getElementById('sidebarUserEmail').textContent;
            console.log('Submitting project for user email:', email);

            // Get user key from email
            getUserKeyByEmail(email, function(userKey) {
                console.log('Received user key:', userKey);
                
                if (!userKey) {
                    document.getElementById('newProjectError').textContent = 'Please make sure you are logged in.';
                    console.error('No userKey found, cannot create project.');
                    return;
                }

                // Check for duplicate project name
                firebase.database().ref(`projects/${userKey}`).once('value')
                    .then(snapshot => {
                        let isDuplicate = false;
                        snapshot.forEach(childSnap => {
                            const project = childSnap.val();
                            if (project.name && project.name.toLowerCase() === name.toLowerCase()) {
                                isDuplicate = true;
                            }
                        });

                        if (isDuplicate) {
                            document.getElementById('newProjectError').textContent = 'A project with this name already exists.';
                            return;
                        }

                        // Calculate duration in months
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        const durationInMonths = (end.getFullYear() - start.getFullYear()) * 12 + 
                                               (end.getMonth() - start.getMonth());
                        const duration = `${durationInMonths} month${durationInMonths !== 1 ? 's' : ''}`;

                        // Create new project data
                        const projectData = {
                            name: name,
                            type: type,
                            description: description,
                            startDate: startDate,
                            endDate: endDate,
                            duration: duration,
                            budget: budget,
                            location: location,
                            leader: leader,
                            status: 'active',
                            progress: 0,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        };

                        console.log('Saving project data for user:', userKey, projectData);

                        // Save to Firebase under the user's projects
                        const userProjectsRef = firebase.database().ref('projects/' + userKey);
                        const newProjectRef = userProjectsRef.push();

                        newProjectRef.set(projectData)
                            .then(() => {
                                console.log('Project saved successfully');
                                closeNewProjectModal();
                                fetchAndRenderProjects(userKey);
                                updateDashboardSummary();
                            })
                            .catch(error => {
                                console.error("Error adding project:", error);
                                document.getElementById('newProjectError').textContent = 'Error saving project. Please try again.';
                            });
                    })
                    .catch(error => {
                        console.error("Error checking for duplicates:", error);
                        document.getElementById('newProjectError').textContent = 'Error checking for duplicates. Please try again.';
                    });
            });
        }

        // --- Team Leader Autocomplete ---
        // Replace Team Leader input with a datalist for autocomplete
        (function() {
            const leaderInput = document.getElementById('npLeader');
            if (!document.getElementById('teamLeaderList')) {
                const datalist = document.createElement('datalist');
                datalist.id = 'teamLeaderList';
                leaderInput.setAttribute('list', 'teamLeaderList');
                leaderInput.parentNode.insertBefore(datalist, leaderInput.nextSibling);
            }
        })();

        function fetchUsersForTeamLeader() {
            if (!(window.firebase && firebase.database)) return;
            const datalist = document.getElementById('teamLeaderList');
            datalist.innerHTML = '';
            firebase.database().ref('users').once('value').then(snapshot => {
                snapshot.forEach(childSnap => {
                    const user = childSnap.val();
                    if (user && user.email) {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.label = user.email + (user.name ? ' (' + user.name + ')' : '');
                        datalist.appendChild(option);
                    }
                });
            });
        }

        // --- Dashboard Summary Logic ---
        function updateDashboardSummary() {
            const email = document.getElementById('sidebarUserEmail').textContent;
            getUserKeyByEmail(email, function(userKey) {
                if (!userKey) {
                    document.getElementById('summary-total').textContent = '0';
                    document.getElementById('summary-inprogress').textContent = '0';
                    document.getElementById('summary-completed').textContent = '0';
                    document.getElementById('dashboard-activities').textContent = 'No projects yet.';
                    document.getElementById('dashboard-progress').innerHTML = '';
                    return;
                }
                firebase.database().ref('projects/' + userKey).once('value').then(snapshot => {
                    let total = 0, inprogress = 0, completed = 0;
                    let activities = [];
                    let progressList = [];
                    snapshot.forEach(childSnap => {
                        const p = childSnap.val();
                        total++;
                        if ((p.status || '').toLowerCase() === 'completed') completed++;
                        else inprogress++;
                        activities.push({name: p.name || 'Untitled Project', status: p.status || 'In Progress', date: p.date || '', createdAt: p.createdAt || ''});
                        progressList.push({name: p.name || 'Untitled Project', progress: p.progress || 0});
                    });
                    document.getElementById('summary-total').textContent = total;
                    document.getElementById('summary-inprogress').textContent = inprogress;
                    document.getElementById('summary-completed').textContent = completed;
                    // Recent Activities
                    const actDiv = document.getElementById('dashboard-activities');
                    if (activities.length === 0) {
                        actDiv.textContent = 'No projects yet.';
                    } else {
                        actDiv.innerHTML = activities.slice(-5).reverse().map(a => `<div style='margin-bottom:8px;'><b>${a.name}</b> - ${a.status} <span style='color:#888; font-size:13px;'>${a.date ? new Date(a.date).toLocaleDateString() : ''}</span></div>`).join('');
                    }
                    // Project Progress
                    const progDiv = document.getElementById('dashboard-progress');
                    if (progressList.length === 0) {
                        progDiv.innerHTML = '';
                    } else {
                        progDiv.innerHTML = progressList.slice(0,3).map(p => `
                            <div style='margin-bottom:12px;'>
                                <span style='font-size:15px;'>• ${p.name}</span>
                                <div style='background:#eee; border-radius:4px; height:8px; width:100%; margin:4px 0;'>
                                    <div style='background:#000; height:8px; border-radius:4px; width:${p.progress}%; transition:width 0.3s;'></div>
                                </div>
                                <span style='font-size:13px; color:#222;'>${p.progress}%</span>
                            </div>
                        `).join('');
                    }
                });
            });
        }
        
        // --- Dashboard Tabs Logic ---
        document.getElementById('overviewTab').onclick = function() {
            document.getElementById('overview-section').style.display = '';
            document.getElementById('analytics-section').style.display = 'none';
            this.style.background = '#000';
            this.style.color = '#fff';
            document.getElementById('analyticsTab').style.background = '#fff';
            document.getElementById('analyticsTab').style.color = '#000';
        };
        document.getElementById('analyticsTab').onclick = function() {
            document.getElementById('overview-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = '';
            this.style.background = '#000';
            this.style.color = '#fff';
            document.getElementById('overviewTab').style.background = '#fff';
            document.getElementById('overviewTab').style.color = '#000';
        };

        // --- Settings Section Logic ---
        // Profile Picture Preview
        document.getElementById('profilePicInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    document.getElementById('profilePicPreview').style.backgroundImage = `url('${evt.target.result}')`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Save Profile Picture
        document.getElementById('saveProfilePicBtn').addEventListener('click', function() {
            const file = document.getElementById('profilePicInput').files[0];
            if (!file) {
                document.getElementById('saveProfilePicMsg').textContent = 'Please select an image first.';
                document.getElementById('saveProfilePicMsg').style.color = '#d32f2f';
                return;
            }
            
            // Check file size - limit to 500KB to avoid database size issues
            if (file.size > 500 * 1024) {
                document.getElementById('saveProfilePicMsg').textContent = 'Image too large. Please select an image under 500KB.';
                document.getElementById('saveProfilePicMsg').style.color = '#d32f2f';
                return;
            }
            
            const msgDiv = document.getElementById('saveProfilePicMsg');
            const spinner = document.getElementById('profilePicSpinner');
            
            // Show loading spinner
            spinner.style.display = 'inline-block';
            msgDiv.textContent = 'Processing image...';
            msgDiv.style.color = '#388e3c';
            
            // Get current user ID
            let uid = '';
            
            if (window.firebase && firebase.auth && firebase.auth().currentUser) {
                uid = firebase.auth().currentUser.uid;
            } else {
                uid = localStorage.getItem('userId');
                if (!uid) {
                    // Generate a unique ID if none exists
                    uid = 'user_' + Date.now();
                    localStorage.setItem('userId', uid);
                }
            }
            
            // Convert image to Base64
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                const base64Image = reader.result;
                
                // Update the sidebar avatar immediately
                document.getElementById('sidebarUserAvatar').style.backgroundImage = `url('${base64Image}')`;
                document.getElementById('sidebarUserAvatar').innerHTML = '';
                
                // Store in localStorage for persistence
                localStorage.setItem('userPhotoURL', base64Image);
                
                // Save the Base64 image to Firebase Realtime Database
                firebase.database().ref('users/' + uid).update({
                    photoURL: base64Image
                }).then(() => {
                    spinner.style.display = 'none';
                    msgDiv.textContent = 'Profile picture updated successfully!';
                    msgDiv.style.color = '#388e3c';
                }).catch(error => {
                    spinner.style.display = 'none';
                    msgDiv.textContent = 'Error updating database: ' + error.message;
                    msgDiv.style.color = '#d32f2f';
                });
            };
            
            reader.onerror = function(error) {
                spinner.style.display = 'none';
                msgDiv.textContent = 'Error reading file: ' + error;
                msgDiv.style.color = '#d32f2f';
            };
        });

        // Dark Mode Toggle
        document.getElementById('darkModeToggle').addEventListener('change', function() {
            document.body.classList.toggle('dark-mode', this.checked);
        });
        // Dark Mode CSS
        const darkModeStyle = document.createElement('style');
        darkModeStyle.innerHTML = `
        body.dark-mode {
            background: #111 !important;
            color: #fff !important;
        }
        body.dark-mode .sidebar, body.dark-mode .main-content, body.dark-mode .content-area, body.dark-mode .header, body.dark-mode .sidebar-user, body.dark-mode .nav-item, body.dark-mode .sidebar-user-avatar, body.dark-mode .sidebar-user-name, body.dark-mode .sidebar-user-email, body.dark-mode .logout-btn, body.dark-mode input, body.dark-mode textarea, body.dark-mode select, body.dark-mode button, body.dark-mode .proj-filter-btn, body.dark-mode .dashboard-tab-btn {
            background: #222 !important;
            color: #fff !important;
            border-color: #444 !important;
        }
        body.dark-mode .nav-item.active, body.dark-mode .proj-filter-btn[style*='background: #000'], body.dark-mode .dashboard-tab-btn[style*='background: #000'] {
            background: #fff !important;
            color: #000 !important;
        }
        body.dark-mode .dashboard-tab-btn[style*='background: #fff'] {
            background: #000 !important;
            color: #fff !important;
        }
        body.dark-mode #dashboard-summary > div, body.dark-mode #dashboard-activities, body.dark-mode #dashboard-progress, body.dark-mode #analytics-section > div {
            background: #222 !important;
            color: #fff !important;
            border-color: #444 !important;
        }
        body.dark-mode .switch .slider {
            background: #444 !important;
        }
        `;
        document.head.appendChild(darkModeStyle);

        // Update the profile picture preview with current photo if available
        const profilePicPreview = document.getElementById('profilePicPreview');
        if (profilePicPreview) {
            const currentPhotoURL = localStorage.getItem('userPhotoURL');
            if (currentPhotoURL) {
                profilePicPreview.style.backgroundImage = `url('${currentPhotoURL}')`;
            } else if (window.firebase && firebase.auth && firebase.auth().currentUser) {
                const user = firebase.auth().currentUser;
                if (user.photoURL) {
                    profilePicPreview.style.backgroundImage = `url('${user.photoURL}')`;
                }
            }
        }

        // Modify the logoutUser function to preserve profile data:
        function logoutUser() {
            // Save user data before logout for potential use in next session
            const currentEmail = document.getElementById('sidebarUserEmail').textContent;
            const currentName = document.getElementById('sidebarUserName').textContent;
            
            if (currentEmail) {
                localStorage.setItem('lastLoggedInEmail', currentEmail);
            }
            if (currentName) {
                localStorage.setItem('lastLoggedInName', currentName);
            }
            // Don't remove userPhotoURL from localStorage to keep the profile picture
            
            // Firebase sign out if available
            if (window.firebase && firebase.auth) {
                firebase.auth().signOut();
            }
            
            // Remove localStorage items but keep profile data
            localStorage.removeItem('tempEmail');
            localStorage.removeItem('tempOTP');
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('tempPhone');
            
            // Redirect to login page
            window.location.href = 'index2.html';
        }

        // Add this new function to load company members
        function loadCompanyMembers() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '<div style="text-align: center; padding: 20px;">Loading members...</div>';

            if (!(window.firebase && firebase.database)) {
                membersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #d32f2f;">Firebase is not initialized</div>';
                return;
            }

            // Listen for real-time updates to the users node
            firebase.database().ref('users').on('value', (snapshot) => {
                const members = [];
                snapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData && userData.email) {
                        members.push({
                            key: childSnapshot.key,
                            email: userData.email,
                            name: userData.name || userData.email.split('@')[0],
                            photoURL: userData.photoURL || '',
                            createdAt: userData.createdAt || Date.now(),
                            isAdmin: userData.isAdmin || false
                        });
                    }
                });

                // Sort members by creation date (newest first)
                members.sort((a, b) => b.createdAt - a.createdAt);

                if (members.length === 0) {
                    membersList.innerHTML = '<div style="text-align: center; padding: 20px;">No members found</div>';
                    return;
                }

                membersList.innerHTML = members.map(member => `
                    <div style="display: flex; align-items: center; gap: 16px; padding: 12px; border-bottom: 1px solid #eee;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: #e0e0e0; background-image: url('${member.photoURL}'); background-size: cover; background-position: center;"></div>
                        <div style="flex:1;">
                            <div style="font-weight: 600; font-size: 16px;">${member.name || member.email.split('@')[0]}</div>
                            <div style="font-size: 13px; color: #888;">${member.email}</div>
                        </div>
                        ${member.isAdmin ? '<span style="color:#1976d2; font-weight:600;">Admin</span>' : ''}
                    </div>
                `).join('');
            }, (error) => {
                console.error('Error loading members:', error);
                membersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #d32f2f;">Error loading members</div>';
            });
        }

        // Add this function to remove a company member
        function removeCompanyMember(userKey, userEmail) {
            if (!confirm('Are you sure you want to remove this member? This action cannot be undone.')) return;
            if (!userKey) return;
            // Prevent removing yourself or admin
            const currentEmail = document.getElementById('sidebarUserEmail').textContent;
            if (userEmail === currentEmail) {
                alert('You cannot remove yourself while logged in.');
                return;
            }
            if (userEmail === 'admin@quill.com') {
                alert('Cannot remove the admin user.');
                return;
            }
            firebase.database().ref('users/' + userKey).remove()
                .then(() => {
                    loadCompanyMembers();
                })
                .catch((error) => {
                    alert('Error removing member: ' + error.message);
                });
        }

        // Show project full view with documents and messages
        function showProjectFullView(project) {
            // Hide projects container and show detail view
            document.getElementById('projectsCardsContainer').style.display = 'none';
            document.getElementById('projectDetailView').style.display = 'block';
            
            // Set current project ID
            document.getElementById('projectDetailView').setAttribute('data-project-id', project._id);
            
            // Load chat messages for this project
            loadProjectChatRealtime(project._id);
            
            // Get user key (admin-user or current user's UID)
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            
            if (!userKey) {
                console.error('User key not found');
                return;
            }

            // Load project data from Firebase
            firebase.database().ref(`projects/${userKey}/${project._id}`).once('value')
                .then(snapshot => {
                    const projectData = snapshot.val();
                    if (!projectData) {
                        console.error('Project data not found');
                        return;
                    }

                    // Update project details
                    document.getElementById('projectDetailTitle').textContent = projectData.name || 'Untitled Project';
                    document.getElementById('pd-description').textContent = projectData.description || 'No description provided';
                    document.getElementById('pd-type').textContent = projectData.type || 'Not specified';
                    document.getElementById('pd-duration').textContent = projectData.duration || 'Not specified';
                    document.getElementById('pd-date').textContent = projectData.date ? new Date(projectData.date).toLocaleDateString() : 'Not specified';
                    document.getElementById('pd-budget').textContent = projectData.budget ? '₱' + projectData.budget : 'Not specified';
                    document.getElementById('pd-location').textContent = projectData.location || 'Not specified';
                    document.getElementById('pd-leader').textContent = projectData.leader || 'Not specified';
                    document.getElementById('pd-status').textContent = projectData.status || 'Active';
                    
                    // Set progress bar
                    const progress = projectData.progress || 0;
                    document.getElementById('pd-progress-bar').style.width = progress + '%';
                    document.getElementById('pd-progress').textContent = progress + '%';
                    
                    // Load team members
                    loadTeamMembers(project._id);
                    
                    // Load tasks in real-time
                    loadProjectTasksRealtime(project._id);
                    
                    // Load budget history
                    loadBudgetLineChart(project._id);
                })
                .catch(error => {
                    console.error('Error loading project data:', error);
                });
        }

        function loadProjectTasksRealtime(projectId) {
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            const tasksList = document.getElementById('projectTasksList');
            if (!userKey) {
                tasksList.innerHTML = '<div style="color: #d32f2f;">User not found</div>';
                return;
            }
            const tasksRef = firebase.database().ref(`projects/${userKey}/${projectId}/tasks`);
            tasksRef.off(); // Remove previous listeners
            tasksRef.on('value', (snapshot) => {
                const tasks = snapshot.val() || {};
                if (Object.keys(tasks).length === 0) {
                    tasksList.innerHTML = '<div style="color: #666;">No tasks yet.</div>';
                    return;
                }
                tasksList.innerHTML = Object.keys(tasks).map(taskId => {
                    const task = tasks[taskId];
                    return `
                        <div style="background: #f8f8f8; border: 1px solid #eee; border-radius: 8px; padding: 12px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-weight: 500;">${task.title || 'Untitled Task'}</div>
                                <div style="font-size: 13px; color: #888;">${task.status || 'Pending'}${task.assignee ? ' • Assigned to: ' + task.assignee : ''}</div>
                                <div style="font-size: 13px; color: #888;">${task.description || ''}</div>
                            </div>
                            <div style="font-size: 13px; color: #888;">
                                ${task.dueDate ? 'Due: ' + new Date(task.dueDate).toLocaleDateString() : ''}
                                <div style="margin-top: 4px; padding: 2px 8px; background: ${task.priority === 'high' ? '#ffebee' : task.priority === 'medium' ? '#fff3e0' : '#e8f5e9'}; color: ${task.priority === 'high' ? '#d32f2f' : task.priority === 'medium' ? '#f57c00' : '#388e3c'}; border-radius: 4px; display: inline-block;">
                                    ${task.priority || 'low'} priority
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function loadProjectChatRealtime(projectId) {
            const chatList = document.getElementById('projectChatMessages');
            if (!chatList) return;
            const chatRef = firebase.database().ref(`projects/admin-user/${projectId}/messages`).limitToLast(100);
            chatRef.off(); // Remove previous listeners
            chatRef.on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                if (Object.keys(messages).length === 0) {
                    chatList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No messages yet. Start the conversation!</div>';
                    return;
                }
                // Convert messages object to array and sort by timestamp
                const messagesArray = Object.entries(messages).map(([id, msg]) => ({
                    id,
                    ...msg
                })).sort((a, b) => a.timestamp - b.timestamp);
                // Generate HTML for messages
                const html = messagesArray.map(msg => {
                    const isCurrentUser = msg.sender === (firebase.auth().currentUser?.email || localStorage.getItem('userEmail'));
                    const messageTime = new Date(msg.timestamp).toLocaleTimeString();
                    const messageDate = new Date(msg.timestamp).toLocaleDateString();
                    return `
                        <div style="margin-bottom: 16px; display: flex; flex-direction: ${isCurrentUser ? 'row-reverse' : 'row'};">
                            <div style="max-width: 70%;">
                                <div style="background: ${isCurrentUser ? '#1976d2' : '#f0f0f0'}; 
                                            color: ${isCurrentUser ? '#fff' : '#333'}; 
                                            padding: 12px 16px; 
                                            border-radius: 12px; 
                                            margin-bottom: 4px;
                                            word-wrap: break-word;">
                                    ${msg.text}
                                </div>
                                <div style="font-size: 12px; color: #666; text-align: ${isCurrentUser ? 'right' : 'left'};">
                                    <span style="font-weight: 500;">${msg.sender}</span>
                                    <span style="margin: 0 4px;">•</span>
                                    <span>${messageDate} ${messageTime}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                chatList.innerHTML = html;
                chatList.scrollTop = chatList.scrollHeight;
            });
        }

        function sendProjectChatMessage() {
            const input = document.getElementById('projectChatInput');
            const text = input.value.trim();
            if (!text) return;
            const projectId = document.getElementById('projectDetailView').getAttribute('data-project-id');
            if (!projectId) return;
            // Get current user info
            const currentUser = firebase.auth().currentUser;
            const userEmail = currentUser?.email || localStorage.getItem('userEmail');
            const userName = document.getElementById('sidebarUserName').textContent || userEmail;
            // Create message object
            const messageData = {
                text: text,
                sender: userName,
                senderEmail: userEmail,
                timestamp: Date.now()
            };
            // Save message to database using admin path
            firebase.database().ref(`projects/admin-user/${projectId}/messages`).push(messageData)
                .then(() => {
                    input.value = '';
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                });
        }

        // Function to load team members
        function loadTeamMembers(projectId) {
            const teamMembersList = document.getElementById('teamMembersList');
            teamMembersList.innerHTML = '<div style="color: #666;">Loading team members...</div>';

            // Get userKey (admin-user or current user's UID)
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            if (!userKey) {
                teamMembersList.innerHTML = '<div style="color: #d32f2f;">User not found</div>';
                return;
            }

            firebase.database().ref(`projects/${userKey}/${projectId}/teamMembers`).once('value')
                .then((snapshot) => {
                    const members = snapshot.val() || {};
                    teamMembersList.innerHTML = '';
                    if (Object.keys(members).length === 0) {
                        teamMembersList.innerHTML = '<div style="color: #666;">No team members added yet.</div>';
                        return;
                    }
                    teamMembersList.innerHTML = Object.keys(members).map(memberId => {
                        const member = members[memberId];
                        return `
                            <div style="background: #f8f8f8; border: 1px solid #eee; border-radius: 8px; padding: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #eee; background-image: url('${member.photoURL || ''}'); background-size: cover; background-position: center;"></div>
                                <div>
                                        <div style="font-weight: 500; margin-bottom: 4px;">${member.name || member.email.split('@')[0]}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">${member.email}</div>
                                        <div style="font-size: 13px; color: #888;">${member.role || 'Team Member'}</div>
                                </div>
                                <button onclick="removeTeamMember('${projectId}', '${memberId}')" style="margin-left: auto; background: none; border: none; color: #d32f2f; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('');
                })
                .catch((error) => {
                    console.error('[loadTeamMembers] Error loading team members:', error);
                    teamMembersList.innerHTML = '<div style="color: #d32f2f;">Error loading team members.</div>';
                });
        }

        // Function to show add team member modal
        function showAddTeamMemberModal() {
            // Create modal if it doesn't exist
            if (!document.getElementById('addTeamMemberModal')) {
                const modal = document.createElement('div');
                modal.id = 'addTeamMemberModal';
                modal.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0,0,0,0.5);
                    z-index: 2001;
                    justify-content: center;
                    align-items: center;
                `;
                modal.innerHTML = `
                    <div style="background: #fff; padding: 24px; border-radius: 8px; width: 400px;">
                        <h3 style="margin-bottom: 16px;">Add Team Member</h3>
                        <select id="teamMemberSelect" style="width: 100%; padding: 8px; margin-bottom: 16px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Select a team member</option>
                        </select>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button onclick="closeAddTeamMemberModal()" style="padding: 8px 16px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer;">Cancel</button>
                            <button onclick="addTeamMember()" style="padding: 8px 16px; border: none; border-radius: 4px; background: #000; color: #fff; cursor: pointer;">Add Member</button>
                        </div>
                        <div id="addTeamMemberError" style="color: #d32f2f; font-size: 13px; margin-top: 12px;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Load available team members
            const select = document.getElementById('teamMemberSelect');
            select.innerHTML = '<option value="">Select a team member</option>';

            // Get current project ID
            const projectId = document.getElementById('projectDetailView').getAttribute('data-project-id');
            if (!projectId) {
                document.getElementById('addTeamMemberError').textContent = 'Project ID not found';
                return;
            }

            // Get user key
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            if (!userKey) {
                document.getElementById('addTeamMemberError').textContent = 'User not found';
                return;
            }

            // Get existing team members to exclude them from the dropdown
            firebase.database().ref(`projects/${userKey}/${projectId}/teamMembers`).once('value')
                .then((snapshot) => {
                    const existingMembers = snapshot.val() || {};
                    const existingEmails = Object.values(existingMembers).map(member => member.email);

                    // Get all users from the database
                    return firebase.database().ref('users').once('value')
                        .then((usersSnapshot) => {
                            usersSnapshot.forEach((userSnap) => {
                                const user = userSnap.val();
                                if (user && user.email && !existingEmails.includes(user.email)) {
                                    const option = document.createElement('option');
                                    option.value = user.email;
                                    option.textContent = user.email + (user.name ? ` (${user.name})` : '');
                                    select.appendChild(option);
                                }
                            });
                        });
                })
                .catch((error) => {
                    console.error('Error loading team members:', error);
                    document.getElementById('addTeamMemberError').textContent = 'Error loading team members';
                });

            // Show modal
            document.getElementById('addTeamMemberModal').style.display = 'flex';
        }

        // Function to close add team member modal
        function closeAddTeamMemberModal() {
            document.getElementById('addTeamMemberModal').style.display = 'none';
            document.getElementById('addTeamMemberError').textContent = '';
        }

        // Function to add team member
        function addTeamMember() {
            const select = document.getElementById('teamMemberSelect');
            const memberEmail = select.value;
            const errorDiv = document.getElementById('addTeamMemberError');

            if (!memberEmail) {
                errorDiv.textContent = 'Please select a team member';
                return;
            }

            // Get current project ID
            const projectId = document.getElementById('projectDetailView').getAttribute('data-project-id');
            if (!projectId) {
                errorDiv.textContent = 'Project ID not found';
                return;
            }

            // Get user key
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            if (!userKey) {
                errorDiv.textContent = 'User not found';
                return;
            }

            // Get user data from Firebase
            firebase.database().ref('users').orderByChild('email').equalTo(memberEmail).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        errorDiv.textContent = 'User not found';
                        return;
                    }

                    const userData = Object.values(snapshot.val())[0];
                    
                    // Add member to project team
                    const memberData = {
                        email: memberEmail,
                        name: userData.name || memberEmail.split('@')[0],
                        photoURL: userData.photoURL || '',
                        role: 'Team Member',
                        addedAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    return firebase.database().ref(`projects/${userKey}/${projectId}/teamMembers`).push(memberData);
                })
                .then(() => {
                    closeAddTeamMemberModal();
                    loadTeamMembers(projectId);
                })
                .catch((error) => {
                    console.error('Error adding team member:', error);
                    errorDiv.textContent = 'Error adding team member: ' + error.message;
                });
        }

        // Function to remove team member
        function removeTeamMember(projectId, memberId) {
            if (!confirm('Are you sure you want to remove this team member?')) {
                return;
            }

            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            if (!userKey) {
                alert('User not found');
                return;
            }

            firebase.database().ref(`projects/${userKey}/${projectId}/teamMembers/${memberId}`).remove()
                .then(() => {
                    loadTeamMembers(projectId);
                })
                .catch((error) => {
                    console.error('Error removing team member:', error);
                    alert('Error removing team member: ' + error.message);
                });
        }

        // Load project documents
        function loadProjectDocuments(projectId) {
            const filesList = document.getElementById('projectFilesList');
            filesList.innerHTML = '<div style="text-align: center; padding: 10px;">Loading documents...</div>';
            
            if (!(window.firebase && firebase.database)) {
                filesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #d32f2f;">Firebase is not initialized</div>';
                return;
            }
            
            // Check if user is admin
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userId = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            
            if (!userId) {
                filesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #d32f2f;">Please log in to view documents</div>';
                return;
            }
            
            // Get documents from Firebase
            firebase.database().ref(`project_documents/${userId}/${projectId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        filesList.innerHTML = '<div style="text-align: center; padding: 10px;">No documents uploaded yet</div>';
                        return;
                    }
                    
                    const documents = [];
                    snapshot.forEach((childSnapshot) => {
                        const doc = childSnapshot.val();
                        doc._id = childSnapshot.key;
                        documents.push(doc);
                    });
                    
                    if (documents.length === 0) {
                        filesList.innerHTML = '<div style="text-align: center; padding: 10px;">No documents uploaded yet</div>';
                        return;
                    }
                    
                    // Sort documents by upload date (newest first)
                    documents.sort((a, b) => b.uploadedAt - a.uploadedAt);
                    
                    // Render documents
                    filesList.innerHTML = documents.map(doc => `
                        <div class="file-item">
                            <div class="file-item-name">
                                <i class="fas fa-file-alt"></i> ${doc.name}
                            </div>
                            <div class="file-item-actions">
                                <button onclick="downloadDocument('${doc._id}', '${doc.name}')" class="file-download-btn" style="background: none; border: none; cursor: pointer; color: #1976d2;">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="deleteDocument('${doc._id}')" class="file-delete-btn" style="background: none; border: none; cursor: pointer; color: #d32f2f;">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch((error) => {
                    console.error('Error loading documents:', error);
                    filesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #d32f2f;">Error loading documents</div>';
                });
        }
        
        // Handle file upload
        function handleFileUpload(files) {
            if (!files || files.length === 0) return;
            
            // Get current project ID
            const projectId = document.getElementById('projectFullViewModal').getAttribute('data-project-id');
            if (!projectId) {
                alert('Project ID not found. Please try again.');
                return;
            }
            
            // Get user ID - check multiple sources
            let userId = '';
            if (firebase.auth().currentUser) {
                userId = firebase.auth().currentUser.uid;
            } else {
                // Try to get from localStorage
                userId = localStorage.getItem('userId');
                if (!userId) {
                    // Generate a unique ID if none exists
                    userId = 'user_' + Date.now();
                    localStorage.setItem('userId', userId);
                }
            }
            
            // Show progress bar
            const progressContainer = document.getElementById('fileUploadProgress');
            const progressBar = document.getElementById('fileProgressBar');
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            // Process each file
            Array.from(files).forEach((file, index) => {
                // Create a storage reference
                const storageRef = firebase.storage().ref();
                const fileRef = storageRef.child(`project_documents/${userId}/${projectId}/${file.name}`);
                
                // Upload file
                const uploadTask = fileRef.put(file);
                
                // Monitor upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Update progress bar
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                    },
                    (error) => {
                        // Handle error
                        console.error('Error uploading file:', error);
                        alert('Error uploading file: ' + error.message);
                        progressContainer.style.display = 'none';
                    },
                    () => {
                        // Upload completed successfully
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            // Save document metadata to Firebase Realtime Database
                            const docData = {
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                url: downloadURL,
                                uploadedAt: firebase.database.ServerValue.TIMESTAMP,
                                uploadedBy: userId
                            };
                            
                            firebase.database().ref(`project_documents/${userId}/${projectId}`).push(docData)
                                .then(() => {
                                    console.log('Document uploaded successfully:', file.name);
                                    
                                    // If this is the last file, hide progress bar and reload documents
                                    if (index === files.length - 1) {
                                        progressContainer.style.display = 'none';
                                        loadProjectDocuments(projectId);
                                        // Always refresh the file list in the project detail view (below progress bar)
                                        getUserKeyByEmail(document.getElementById('sidebarUserEmail').textContent, function(userKey) {
                                            loadProjectFilesListDetail(projectId, userKey);
                                        });
                                    }
                                })
                                .catch((error) => {
                                    console.error('Error saving document metadata:', error);
                                    alert('Error saving document metadata: ' + error.message);
                                    progressContainer.style.display = 'none';
                                });
                        });
                    }
                );
            });
        }
        
        // Download document
        function downloadDocument(docId, docName) {
            // Get current project ID
            const projectId = document.getElementById('projectFullViewModal').getAttribute('data-project-id');
            if (!projectId) {
                alert('Project ID not found. Please try again.');
                return;
            }
            
            // Get current user
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                alert('Please log in to download documents.');
                return;
            }
            
            // Get document URL from Firebase
            firebase.database().ref(`project_documents/${currentUser.uid}/${projectId}/${docId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('Document not found.');
                        return;
                    }
                    
                    const doc = snapshot.val();
                    
                    // Create a temporary link and trigger download
                    const link = document.createElement('a');
                    link.href = doc.url;
                    link.download = doc.name;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch((error) => {
                    console.error('Error downloading document:', error);
                    alert('Error downloading document: ' + error.message);
                });
        }
        
        // Delete document
        function deleteDocument(docId) {
            if (!confirm('Are you sure you want to delete this document?')) return;
            
            // Get current project ID
            const projectId = document.getElementById('projectFullViewModal').getAttribute('data-project-id');
            if (!projectId) {
                alert('Project ID not found. Please try again.');
                return;
            }
            
            // Get current user
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                alert('Please log in to delete documents.');
                return;
            }
            
            // Get document URL from Firebase
            firebase.database().ref(`project_documents/${currentUser.uid}/${projectId}/${docId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('Document not found.');
                        return;
                    }
                    
                    const doc = snapshot.val();
                    
                    // Delete file from Storage
                    const storageRef = firebase.storage().refFromURL(doc.url);
                    storageRef.delete()
                        .then(() => {
                            // Delete metadata from Realtime Database
                            firebase.database().ref(`project_documents/${currentUser.uid}/${projectId}/${docId}`).remove()
                                .then(() => {
                                    console.log('Document deleted successfully');
                                    loadProjectDocuments(projectId);
                                })
                                .catch((error) => {
                                    console.error('Error deleting document metadata:', error);
                                    alert('Error deleting document metadata: ' + error.message);
                                });
                        })
                        .catch((error) => {
                            console.error('Error deleting document from storage:', error);
                            alert('Error deleting document from storage: ' + error.message);
                        });
                })
                .catch((error) => {
                    console.error('Error getting document:', error);
                    alert('Error getting document: ' + error.message);
                });
        }
        
        // Load project messages
        function loadProjectMessages(projectId) {
            const messagesList = document.getElementById('projectMessagesList');
            messagesList.innerHTML = '<div style="text-align: center; padding: 10px;">Loading messages...</div>';
            
            if (!(window.firebase && firebase.database)) {
                messagesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #d32f2f;">Firebase is not initialized</div>';
                return;
            }
            
            // Get user ID - check multiple sources
            let userId = '';
            if (firebase.auth().currentUser) {
                userId = firebase.auth().currentUser.uid;
            } else {
                // Try to get from localStorage
                userId = localStorage.getItem('userId');
                if (!userId) {
                    // Generate a unique ID if none exists
                    userId = 'user_' + Date.now();
                    localStorage.setItem('userId', userId);
                }
            }
            
            // Get messages from Firebase
            firebase.database().ref(`project_messages/${userId}/${projectId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        messagesList.innerHTML = '<div style="text-align: center; padding: 10px;">No messages yet</div>';
                        return;
                    }
                    
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        const msg = childSnapshot.val();
                        msg._id = childSnapshot.key;
                        messages.push(msg);
                    });
                    
                    if (messages.length === 0) {
                        messagesList.innerHTML = '<div style="text-align: center; padding: 10px;">No messages yet</div>';
                        return;
                    }
                    
                    // Sort messages by timestamp (oldest first)
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Render messages
                    messagesList.innerHTML = messages.map(msg => `
                        <div class="message-item">
                            <div class="message-sender">${msg.sender}</div>
                            <div class="message-text">${msg.text}</div>
                            <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('');
                    
                    // Scroll to bottom
                    messagesList.scrollTop = messagesList.scrollHeight;
                })
                .catch((error) => {
                    console.error('Error loading messages:', error);
                    messagesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #d32f2f;">Error loading messages</div>';
                });
        }
        
        // Send project message
        function sendProjectMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            // Get current project ID
            const projectId = document.getElementById('projectFullViewModal').getAttribute('data-project-id');
            if (!projectId) {
                alert('Project ID not found. Please try again.');
                return;
            }
            
            // Get user ID and email - check multiple sources
            let userId = '';
            let userEmail = '';
            
            if (firebase.auth().currentUser) {
                userId = firebase.auth().currentUser.uid;
                userEmail = firebase.auth().currentUser.email;
            } else {
                // Try to get from localStorage
                userId = localStorage.getItem('userId');
                userEmail = localStorage.getItem('userEmail') || localStorage.getItem('tempEmail');
                
                if (!userId) {
                    // Generate a unique ID if none exists
                    userId = 'user_' + Date.now();
                    localStorage.setItem('userId', userId);
                }
            }
            
            // Create message data
            const messageData = {
                text: messageText,
                sender: userEmail || 'User',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save message to Firebase
            firebase.database().ref(`project_messages/${userId}/${projectId}`).push(messageData)
                .then(() => {
                    console.log('Message sent successfully');
                    messageInput.value = '';
                    loadProjectMessages(projectId);
                })
                .catch((error) => {
                    console.error('Error sending message:', error);
                    alert('Error sending message: ' + error.message);
                });
        }

        // Function to load team leaders from Firebase
        function loadTeamLeaders() {
            const leaderSelect = document.getElementById('npLeader');
            // Clear existing options except the first one
            while (leaderSelect.options.length > 1) {
                leaderSelect.remove(1);
            }

            if (!(window.firebase && firebase.database)) {
                console.error('Firebase is not initialized');
                return;
            }

            firebase.database().ref('users').once('value')
                .then(snapshot => {
                    snapshot.forEach(childSnap => {
                        const user = childSnap.val();
                        if (user && user.email) {
                            const option = document.createElement('option');
                            option.value = user.email;
                            option.textContent = user.email + (user.name ? ` (${user.name})` : '');
                            leaderSelect.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading team leaders:', error);
                });
        }

        // Modify the addNewBudget function to work for all users
        function addNewBudget() {
            const projectId = document.getElementById('projectFullViewModal').getAttribute('data-project-id');
            const newBudgetInput = document.getElementById('newBudgetInput');
            const addBudgetMsg = document.getElementById(`budgetMsg_${projectId}`);
            const additionalBudget = parseFloat(newBudgetInput.value);

            if (isNaN(additionalBudget) || additionalBudget <= 0) {
                addBudgetMsg.textContent = 'Please enter a valid budget amount.';
                addBudgetMsg.style.color = '#d32f2f';
                return;
            }

            // Get current user's email
            const currentUserEmail = document.getElementById('sidebarUserEmail').textContent;
            
            // Get current budget from display
            const currentBudgetText = document.getElementById('pfv-budget').textContent;
            const currentBudget = parseFloat(currentBudgetText.replace('₱', '')) || 0;
            const newTotalBudget = currentBudget + additionalBudget;

            // Get user key for the current user
            getUserKeyByEmail(currentUserEmail, function(userKey) {
                if (!userKey) {
                    addBudgetMsg.textContent = 'Error: User not found.';
                    addBudgetMsg.style.color = '#d32f2f';
                    return;
                }

                // Update budget in Firebase
                const projectRef = firebase.database().ref(`projects/${userKey}/${projectId}`);
                
                // First get the current project data
                projectRef.once('value')
                    .then((snapshot) => {
                        const projectData = snapshot.val();
                        if (!projectData) {
                            throw new Error('Project not found');
                        }

                        // Update the budget
                        return projectRef.update({
                            budget: newTotalBudget,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        });
                    })
                    .then(() => {
                        // Update display in the modal
                        document.getElementById('pfv-budget').textContent = '₱' + newTotalBudget;
                        newBudgetInput.value = '';
                        addBudgetMsg.textContent = `Added ₱${additionalBudget} to budget. New total: ₱${newTotalBudget}`;
                        addBudgetMsg.style.color = '#388e3c';
                        
                        // Add to budget history
                        const now = Date.now();
                        firebase.database().ref(`projects/${userKey}/${projectId}/budgetHistory`).push({
                            date: now,
                            value: newTotalBudget,
                            added: additionalBudget,
                            addedBy: currentUserEmail
                        });

                        // Refresh the project cards to show updated budget
                        const email = document.getElementById('sidebarUserEmail').textContent;
                        getUserKeyByEmail(email, function(userKey) {
                            fetchAndRenderProjects(userKey);
                        });
                    })
                    .catch(error => {
                        console.error('Error updating budget:', error);
                        addBudgetMsg.textContent = 'Error updating budget. Please try again.';
                        addBudgetMsg.style.color = '#d32f2f';
                    });
            });
        }

        // Add these new functions
        function backToProjects() {
            document.getElementById('projectDetailView').style.display = 'none';
            document.getElementById('projectsCardsContainer').style.display = 'flex';
        }

        // Inside showAddTaskModal() or similar function
        const select = document.getElementById('taskAssigneeSelect');
        select.innerHTML = '<option value="">Select team member...</option>';

        // Fetch project data to get the leader's email
        firebase.database().ref('projects/admin-user/' + projectId).once('value').then(projectSnap => {
            const project = projectSnap.val();
            if (project && project.leader) {
                const option = document.createElement('option');
                option.value = project.leader.trim().toLowerCase();
                option.textContent = project.leader;
                select.appendChild(option);
            }
        });

        function loadLeaderMyTasks(projectId, leaderEmail) {
            const myTasksDiv = document.getElementById('myTasksList');
            myTasksDiv.innerHTML = 'Loading...';

            firebase.database().ref('projects/admin-user/' + projectId + '/tasks').once('value').then(snapshot => {
                let html = '';
                let hasTasks = false;
                snapshot.forEach(taskSnap => {
                    const task = taskSnap.val();
                    if ((task.assignee || '').trim().toLowerCase() === leaderEmail.trim().toLowerCase()) {
                        hasTasks = true;
                        html += `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; border: 1px solid #ddd;">
                                <div style="font-weight: 600;">${task.title || 'Untitled Task'}</div>
                                <div style="color: #666;">${task.description || ''}</div>
                                <div style="color: #888;">Due: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date'}</div>
                                <div style="color: #888;">Status: ${task.status || 'pending'}</div>
                            </div>
                        `;
                    }
                });
                myTasksDiv.innerHTML = hasTasks ? html : 'No tasks assigned to you.';
            });
        }

        // Add these new functions for task management
        function showAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            modal.style.display = 'flex';
            
            // Clear previous values
            document.getElementById('taskTitleInput').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskDueDate').value = '';
            document.getElementById('taskAssignee').value = '';
            document.getElementById('taskPriority').value = 'low';
            document.getElementById('addTaskError').textContent = '';
            
            // Load team members for assignment
            loadTeamMembersForTask();
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
        }

        function loadTeamMembersForTask() {
            const assigneeSelect = document.getElementById('taskAssignee');
            assigneeSelect.innerHTML = '<option value="">Select team leader...</option>';
            
            // Get current project ID
            const projectId = document.getElementById('projectDetailView').getAttribute('data-project-id');
            if (!projectId) return;
            
            // Get user key
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            
            if (!userKey) return;
            
            // Get the project data to find the assigned team leader
            firebase.database().ref(`projects/${userKey}/${projectId}`).once('value')
                .then((snapshot) => {
                    const project = snapshot.val();
                    if (!project || !project.leader) {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "No team leader assigned to project";
                        option.disabled = true;
                        assigneeSelect.appendChild(option);
                        return;
                    }

                    // Add the project's team leader to the dropdown
                    const option = document.createElement('option');
                    option.value = project.leader;
                    option.textContent = `${project.leader} (Project Team Leader)`;
                    assigneeSelect.appendChild(option);
                })
                .catch(error => {
                    console.error('Error loading team leader:', error);
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Error loading team leader";
                    option.disabled = true;
                    assigneeSelect.appendChild(option);
                });
        }

        function submitNewTask() {
            const taskTitle = document.getElementById('taskTitleInput').value.trim();
            const taskDescription = document.getElementById('taskDescription').value.trim();
            const taskDueDate = document.getElementById('taskDueDate').value;
            const taskAssignee = document.getElementById('taskAssignee').value;
            const taskPriority = document.getElementById('taskPriority').value;
            
            if (!taskTitle) {
                document.getElementById('addTaskError').textContent = 'Task title is required.';
                return;
            }
            
            if (!taskAssignee) {
                document.getElementById('addTaskError').textContent = 'Please select the team leader.';
                return;
            }
            
            // Get current project ID
            const projectId = document.getElementById('projectDetailView').getAttribute('data-project-id');
            if (!projectId) {
                document.getElementById('addTaskError').textContent = 'Project ID not found.';
                return;
            }
            
            // Get user key
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userKey = isAdmin ? 'admin-user' : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
            
            if (!userKey) {
                document.getElementById('addTaskError').textContent = 'User not found.';
                return;
            }
            
            // Verify that the assignee is the project's team leader
            firebase.database().ref(`projects/${userKey}/${projectId}`).once('value')
                .then((snapshot) => {
                    const project = snapshot.val();
                    if (!project || project.leader !== taskAssignee) {
                        document.getElementById('addTaskError').textContent = 'Selected assignee is not the project team leader.';
                        return;
                    }
                    
                    // Create task data
                    const taskData = {
                        title: taskTitle,
                        description: taskDescription,
                        dueDate: taskDueDate,
                        assignee: taskAssignee,
                        priority: taskPriority,
                        status: 'pending',
                        createdAt: Date.now()
                    };
                    
                    // Save task to Firebase
                    return firebase.database().ref(`projects/${userKey}/${projectId}/tasks`).push(taskData);
                })
                .then(() => {
                    if (document.getElementById('addTaskError').textContent === '') {
                        console.log('Task added successfully');
                        closeAddTaskModal();
                        loadProjectTasksRealtime(projectId);
                    }
                })
                .catch(error => {
                    console.error('Error adding task:', error);
                    document.getElementById('addTaskError').textContent = 'Error adding task: ' + error.message;
                });
        }

        // Generate Project Report
        function generateProjectReport() {
            const projectId = document.getElementById('projectDetailView').getAttribute('data-project-id');
            if (!projectId) {
                alert('Project ID not found. Please try again.');
                return;
            }

            getUserKeyByEmail(document.getElementById('sidebarUserEmail').textContent, function(userKey) {
                if (!userKey) {
                    alert('User not found. Please log in again.');
                    return;
                }

                firebase.database().ref(`projects/${userKey}/${projectId}`).once('value').then(projectSnap => {
                    const project = projectSnap.val();
                    if (!project) {
                        alert('Project not found. Please try again.');
                        return;
                    }

                    Promise.all([
                        firebase.database().ref(`projects/${userKey}/${projectId}/tasks`).once('value'),
                        firebase.database().ref(`projects/${userKey}/${projectId}/teamMembers`).once('value')
                    ]).then(([tasksSnap, teamSnap]) => {
                        // New Budget Deduction Table
                        let budgetDeductionHtml = `
                            <h4>Budget Deductions</h4>
                            <table style="width:100%;border-collapse:collapse;">
                                <tr style="background:#f0f0f0;">
                                    <th style="border:1px solid #ccc;padding:6px;">Date</th>
                                    <th style="border:1px solid #ccc;padding:6px;">Budget Deducted</th>
                                    <th style="border:1px solid #ccc;padding:6px;">Reason for Deduction</th>
                                </tr>
                        `;
                        if (project.budgetHistory) {
                            const history = Object.values(project.budgetHistory).filter(bh => bh.deducted);
                            if (history.length > 0) {
                                budgetDeductionHtml += history.map(bh =>
                                    `<tr>
                                        <td style="border:1px solid #ccc;padding:6px;">${bh.date ? new Date(bh.date).toLocaleDateString() : ''}</td>
                                        <td style="border:1px solid #ccc;padding:6px;">${bh.deducted ? '₱' + bh.deducted : ''}</td>
                                        <td style="border:1px solid #ccc;padding:6px;">${bh.purpose || ''}</td>
                                    </tr>`
                                ).join('');
                            } else {
                                budgetDeductionHtml += `<tr><td colspan="3" style="text-align:center; color:#888;">No deductions yet.</td></tr>`;
                            }
                        } else {
                            budgetDeductionHtml += `<tr><td colspan="3" style="text-align:center; color:#888;">No deductions yet.</td></tr>`;
                        }
                        budgetDeductionHtml += '</table>';

                        // Team Members
                        let teamHtml = 'No team members yet.';
                        if (teamSnap.exists()) {
                            const members = [];
                            teamSnap.forEach(child => {
                                const m = child.val();
                                members.push(`<tr>
                                    <td style="border:1px solid #ccc;padding:6px;">${m.name || m.email || 'Unknown'}</td>
                                    <td style="border:1px solid #ccc;padding:6px;">${m.role || 'Team Member'}</td>
                                    <td style="border:1px solid #ccc;padding:6px;">${m.email || ''}</td>
                                </tr>`);
                            });
                            teamHtml = `<table style="width:100%;border-collapse:collapse;">
                                <tr style="background:#f0f0f0;">
                                    <th style="border:1px solid #ccc;padding:6px;">Name</th>
                                    <th style="border:1px solid #ccc;padding:6px;">Role</th>
                                    <th style="border:1px solid #ccc;padding:6px;">Email</th>
                                </tr>
                                ${members.join('')}
                            </table>`;
                        }

                        // Tasks
                        let tasksHtml = 'No tasks yet.';
                        if (tasksSnap.exists()) {
                            const tasks = [];
                            tasksSnap.forEach(child => {
                                const t = child.val();
                                tasks.push(`<tr>
                                    <td style="border:1px solid #ccc;padding:6px;">${t.name || 'Untitled Task'}</td>
                                    <td style="border:1px solid #ccc;padding:6px;">${t.status || 'pending'}</td>
                                    <td style="border:1px solid #ccc;padding:6px;">${t.assignee || ''}</td>
                                    <td style="border:1px solid #ccc;padding:6px;">${t.dueDate ? new Date(t.dueDate).toLocaleDateString() : ''}</td>
                                </tr>`);
                            });
                            tasksHtml = `<table style="width:100%;border-collapse:collapse;">
                                <tr style="background:#f0f0f0;">
                                    <th style="border:1px solid #ccc;padding:6px;">Task Name</th>
                                    <th style="border:1px solid #ccc;padding:6px;">Status</th>
                                    <th style="border:1px solid #ccc;padding:6px;">Assignee</th>
                                    <th style="border:1px solid #ccc;padding:6px;">Due Date</th>
                                </tr>
                                ${tasks.join('')}
                            </table>`;
                        }

                        // Compose report
                        const reportContent = `
                            <div id="project-report-pdf" style="font-family:sans-serif; max-width:700px; margin:0 auto; text-align:center;">
                                <h2 style="text-align:center;">Project Report</h2>
                                <table style="width:100%;margin-bottom:20px;text-align:left;margin-left:auto;margin-right:auto;">
                                    <tr><td style="font-weight:bold;width:180px;">Project Name:</td><td>${project.name}</td></tr>
                                    <tr><td style="font-weight:bold;">Date Start:</td><td>${project.startDate ? new Date(project.startDate).toLocaleDateString() : 'N/A'}</td></tr>
                                    <tr><td style="font-weight:bold;">Date End:</td><td>${project.endDate ? new Date(project.endDate).toLocaleDateString() : 'N/A'}</td></tr>
                                    <tr><td style="font-weight:bold;">Budget:</td><td>₱${project.budget || 'N/A'}</td></tr>
                                    <tr><td style="font-weight:bold;">Location:</td><td>${project.location || ''}</td></tr>
                                    <tr><td style="font-weight:bold;">Team Leader:</td><td>${project.leader || ''}</td></tr>
                                    <tr><td style="font-weight:bold;">Status:</td><td>${project.status || ''}</td></tr>
                                    <tr><td style="font-weight:bold;">Progress:</td><td>${project.progress || 0}%</td></tr>
                                </table>
                                ${budgetDeductionHtml}
                                <h3 style="margin-top:24px;">Team Members</h3>
                                ${teamHtml}
                                <h3 style="margin-top:24px;">Tasks</h3>
                                ${tasksHtml}
                            </div>
                        `;

                        document.getElementById('projectReportContent').innerHTML = reportContent;
                        document.getElementById('projectReportModal').style.display = 'flex';
                    });
                });
            });
        }

        // PDF Download
        function downloadProjectReport() {
            const reportElement = document.getElementById('project-report-pdf');
            if (!reportElement) {
                alert('No report to download.');
                return;
            }
            html2canvas(reportElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                let pdfWidth = pageWidth * 0.9; // 90% of page width for margin
                let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                if (pdfHeight > pageHeight * 0.95) {
                    pdfHeight = pageHeight * 0.95;
                    pdfWidth = (imgProps.width * pdfHeight) / imgProps.height;
                }
                const x = (pageWidth - pdfWidth) / 2;
                const y = (pageHeight - pdfHeight) / 2;
                pdf.addImage(imgData, 'PNG', x, y, pdfWidth, pdfHeight);
                pdf.save('project_report.pdf');
            });
        }

        // Close Project Report Modal
        function closeProjectReportModal() {
            document.getElementById('projectReportModal').style.display = 'none';
        }

        // ... existing code ...
        function deductBudget() {
            const projectId = document.getElementById('projectFullViewModal').getAttribute('data-project-id');
            const deductInput = document.getElementById('deductBudgetInput');
            const purposeInput = document.getElementById('deductPurposeInput');
            const deductMsg = document.getElementById('deductBudgetMsg');
            const amount = parseFloat(deductInput.value);
            const purpose = purposeInput.value.trim();
            const currentUserEmail = document.getElementById('sidebarUserEmail').textContent;

            if (isNaN(amount) || amount <= 0) {
                deductMsg.textContent = 'Please enter a valid deduction amount.';
                deductMsg.style.color = '#d32f2f';
                return;
            }

            // Get current budget
            const currentBudgetText = document.getElementById('pfv-budget').textContent;
            const currentBudget = parseFloat(currentBudgetText.replace('₱', '')) || 0;
            if (amount > currentBudget) {
                deductMsg.textContent = 'Cannot deduct more than current budget.';
                deductMsg.style.color = '#d32f2f';
                return;
            }
            const newTotalBudget = currentBudget - amount;

            getUserKeyByEmail(currentUserEmail, function(userKey) {
                if (!userKey) {
                    deductMsg.textContent = 'Error: User not found.';
                    deductMsg.style.color = '#d32f2f';
                    return;
                }
                const projectRef = firebase.database().ref(`projects/${userKey}/${projectId}`);
                projectRef.once('value')
                    .then((snapshot) => {
                        const projectData = snapshot.val();
                        if (!projectData) throw new Error('Project not found');
                        return projectRef.update({
                            budget: newTotalBudget,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        });
                    })
                    .then(() => {
                        document.getElementById('pfv-budget').textContent = '₱' + newTotalBudget;
                        deductInput.value = '';
                        purposeInput.value = '';
                        deductMsg.textContent = `Deducted ₱${amount}. New total: ₱${newTotalBudget}`;
                        deductMsg.style.color = '#388e3c';

                        // Add to budget history
                        const now = Date.now();
                        firebase.database().ref(`projects/${userKey}/${projectId}/budgetHistory`).push({
                            date: now,
                            value: newTotalBudget,
                            deducted: amount,
                            deductedBy: currentUserEmail,
                            purpose: purpose
                        });
                    })
                    .catch(error => {
                        console.error('Error deducting budget:', error);
                        deductMsg.textContent = 'Error deducting budget. Please try again.';
                        deductMsg.style.color = '#d32f2f';
                    });
            });
        }
        // ... existing code ...

        // ... existing code ...
        function renderBudgetHistoryTable(projectId) {
            const tableDiv = document.getElementById('budgetHistoryTable');
            if (!tableDiv) return;
            tableDiv.innerHTML = 'Loading...';
            // Use the correct user key if needed, here using admin-user for team leader view
            firebase.database().ref(`projects/admin-user/${projectId}/budgetHistory`).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    tableDiv.innerHTML = 'No budget history yet.';
                    return;
                }
                let html = `
                    <table style="width:100%;border-collapse:collapse;">
                        <tr style="background:#f0f0f0;">
                            <th style="border:1px solid #ccc;padding:6px;">Date</th>
                            <th style="border:1px solid #ccc;padding:6px;">Budget deduction</th>
                            <th style="border:1px solid #ccc;padding:6px;">Purpose of deduction</th>
                            <th style="border:1px solid #ccc;padding:6px;">Deducted By</th>
                        </tr>
                `;
                snapshot.forEach(childSnap => {
                    const bh = childSnap.val();
                    if (bh.deducted) { // Only show rows with a deduction
                        html += `
                        <tr>
                            <td style="border:1px solid #ccc;padding:6px;">${bh.date ? new Date(bh.date).toLocaleDateString() : ''}</td>
                            <td style="border:1px solid #ccc;padding:6px;">${bh.deducted ? '₱' + bh.deducted : ''}</td>
                            <td style="border:1px solid #ccc;padding:6px;">${bh.purpose || ''}</td>
                            <td style="border:1px solid #ccc;padding:6px;">${bh.deductedBy || ''}</td>
                        </tr>
                        `;
                    }
                });
                html += '</table>';
                tableDiv.innerHTML = html;
            });
        }
        // ... existing code ...
        // In your function that opens the project detail view (e.g., showProjectFullView or openProjectViewModal), after loading the project, call:
        // renderBudgetHistoryTable(projectId);
        // ... existing code ...
        // 2. Add the renderBudgetDeductionsTable function to your script:
        function renderBudgetDeductionsTable(projectId, userKey) {
            const tableDiv = document.getElementById('budgetDeductionsTable');
            if (!tableDiv) return;
            tableDiv.innerHTML = `
                <h4>Budget Deductions</h4>
                <table style="width:100%;border-collapse:collapse;">
                    <tr style="background:#f0f0f0;">
                        <th style="border:1px solid #ccc;padding:6px;">Total budget</th>
                        <th style="border:1px solid #ccc;padding:6px;">Budget deducted</th>
                        <th style="border:1px solid #ccc;padding:6px;">Reason for deduction</th>
                        <th style="border:1px solid #ccc;padding:6px;">Date</th>
                    </tr>
                    <tbody id="budgetDeductionsRows"></tbody>
                </table>
            `;
            firebase.database().ref(`projects/${userKey}/${projectId}/budgetHistory`).once('value').then(snapshot => {
                const tbody = document.getElementById('budgetDeductionsRows');
                if (!snapshot.exists()) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#888;">No deductions yet.</td></tr>`;
                    return;
                }
                let rows = '';
                snapshot.forEach(childSnap => {
                    const bh = childSnap.val();
                    if (bh.deducted) {
                        rows += `
                            <tr>
                                <td style="border:1px solid #ccc;padding:6px;">₱${bh.value || ''}</td>
                                <td style="border:1px solid #ccc;padding:6px;">${bh.deducted ? '₱' + bh.deducted : ''}</td>
                                <td style="border:1px solid #ccc;padding:6px;">${bh.purpose || ''}</td>
                                <td style="border:1px solid #ccc;padding:6px;">${bh.date ? new Date(bh.date).toLocaleDateString() : ''}</td>
                            </tr>
                        `;
                    }
                });
                if (!rows) {
                    rows = `<tr><td colspan="4" style="text-align:center; color:#888;">No deductions yet.</td></tr>`;
                }
                tbody.innerHTML = rows;
            });
        }
        // ... existing code ...
        // 3. In showProjectFullView, after loading project details, call:
        // getUserKeyByEmail(document.getElementById('sidebarUserEmail').textContent, function(userKey) { renderBudgetDeductionsTable(project._id, userKey); });
        // ... existing code ...

        function loadProjectFilesListDetail(projectId, userKey) {
            const filesList = document.getElementById('projectFilesListDetail');
            filesList.innerHTML = '<div style="color:#888;">Loading files...</div>';

            if (!(window.firebase && firebase.database)) {
                filesList.innerHTML = '<div style="color:#d32f2f;">Firebase is not initialized</div>';
                return;
            }

            // Fetch from the correct path: projects/{userKey}/{projectId}/files
            firebase.database().ref(`projects/${userKey}/${projectId}/files`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        filesList.innerHTML = '<div style="color:#888;">No files uploaded yet.</div>';
                        return;
                    }
                    const files = [];
                    snapshot.forEach(childSnap => {
                        const file = childSnap.val();
                        files.push(file);
                    });
                    if (files.length === 0) {
                        filesList.innerHTML = '<div style="color:#888;">No files uploaded yet.</div>';
                        return;
                    }
                    filesList.innerHTML = `
                        <div style="margin-top:12px; font-weight:600; font-size:16px;">Uploaded Files</div>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            ${files.map(file => `
                                <div style="display: flex; align-items: center; background: #f8f8f8; border: 1px solid #eee; border-radius: 8px; padding: 10px 14px; gap: 14px;">
                                    <div style="font-size: 22px; color: #1976d2; margin-right: 8px;"><i class='fas fa-file-alt'></i></div>
                                    <div style="flex:1; min-width:0;">
                                        <div style="font-weight: 500; color: #222; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${file.name}</div>
                                        <div style="font-size: 13px; color: #888;">
                                            ${file.size ? (Math.round((file.size/1024)*10)/10) + ' KB' : ''}
                                            ${file.uploadedAt ? ' &middot; ' + new Date(file.uploadedAt).toLocaleDateString() : ''}
                                        </div>
                                    </div>
                                    <a href="${file.url}" download="${file.name}" target="_blank" style="background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 14px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: background 0.2s;">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    `;
                })
                .catch((error) => {
                    console.error('Error loading files:', error);
                    filesList.innerHTML = '<div style="color:#d32f2f;">Error loading files</div>';
                });
        }

        // Add this function to load archived projects
        function loadArchivedProjects() {
            const archivedProjectsList = document.getElementById('archivedProjectsList');
            const archiveEmpty = document.getElementById('archiveEmpty');
            archivedProjectsList.innerHTML = '';
            archiveEmpty.style.display = 'none';
            // Get user key
            const email = document.getElementById('sidebarUserEmail').textContent;
            getUserKeyByEmail(email, function(userKey) {
                if (!userKey) {
                    archiveEmpty.style.display = 'block';
                    return;
                }
                firebase.database().ref('projects/' + userKey).once('value')
                    .then(snapshot => {
                        const projects = [];
                        snapshot.forEach(childSnap => {
                            const project = childSnap.val();
                            if (project.archived === true) {
                                project._id = childSnap.key;
                                projects.push(project);
                            }
                        });
                        if (projects.length === 0) {
                            archiveEmpty.style.display = 'block';
                            return;
                        }
                        // Sort by completedAt or lastUpdated
                        projects.sort((a, b) => (b.completedAt || b.lastUpdated || 0) - (a.completedAt || a.lastUpdated || 0));
                        projects.forEach(project => {
                            const card = document.createElement('div');
                            card.style.background = '#fff';
                            card.style.border = '1px solid #ddd';
                            card.style.borderRadius = '8px';
                            card.style.padding = '20px';
                            card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                            card.innerHTML = `
                                <div style="margin-bottom: 16px;">
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${project.name || 'Untitled Project'}</h3>
                                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">${project.description || 'No description'}</p>
                                </div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Type:</strong> ${project.type || 'Not specified'}</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Duration:</strong> ${project.duration || 'Not specified'}</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Budget:</strong> ${project.budget ? '₱' + project.budget : 'Not specified'}</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Location:</strong> ${project.location || 'Not specified'}</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Team Leader:</strong> ${project.leader || 'Not specified'}</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Completed:</strong> ${project.completedAt ? new Date(project.completedAt).toLocaleDateString() : 'Not specified'}</div>
                                <button onclick="openArchiveProjectViewModal('${project._id}')" style="margin-top: 12px; background: #fff; border: 1px solid #000; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">View Details</button>
                            `;
                            archivedProjectsList.appendChild(card);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading archived projects:', error);
                        archiveEmpty.textContent = 'Error loading archived projects. Please try again.';
                        archiveEmpty.style.display = 'block';
                    });
            });
        }

        // ... existing code ...
        function openArchiveProjectViewModal(projectId) {
            // Show modal
            document.getElementById('archiveProjectViewModal').style.display = 'flex';
            document.getElementById('archiveProjectDetails').innerHTML = 'Loading...';

            // Get user key
            const email = document.getElementById('sidebarUserEmail').textContent;
            getUserKeyByEmail(email, function(userKey) {
                if (!userKey) {
                    document.getElementById('archiveProjectDetails').innerHTML = '<div style="color:#d32f2f;">User not found.</div>';
                    return;
                }
                firebase.database().ref('projects/' + userKey + '/' + projectId).once('value')
                    .then(snapshot => {
                        const project = snapshot.val();
                        if (!project) {
                            document.getElementById('archiveProjectDetails').innerHTML = '<div style="color:#d32f2f;">Project not found.</div>';
                            return;
                        }
                        // Render main project details
                        let html = `
                            <div style="margin-bottom: 16px;"><strong>Description:</strong> ${project.description || 'No description'}</div>
                            <div style="margin-bottom: 8px;"><strong>Type:</strong> ${project.type || 'Not specified'}</div>
                            <div style="margin-bottom: 8px;"><strong>Duration:</strong> ${project.duration || 'Not specified'}</div>
                            <div style="margin-bottom: 8px;"><strong>Budget:</strong> ${project.budget ? '₱' + project.budget : 'Not specified'}</div>
                            <div style="margin-bottom: 8px;"><strong>Location:</strong> ${project.location || 'Not specified'}</div>
                            <div style="margin-bottom: 8px;"><strong>Team Leader:</strong> ${project.leader || 'Not specified'}</div>
                            <div style="margin-bottom: 8px;"><strong>Status:</strong> ${project.status || 'Not specified'}</div>
                            <div style="margin-bottom: 8px;"><strong>Completed:</strong> ${project.completedAt ? new Date(project.completedAt).toLocaleDateString() : 'Not specified'}</div>
                        `;
                        // Team Members
                        html += `<div style='margin-top:16px;'><strong>Team Members:</strong><ul style='margin:8px 0 0 16px;'>`;
                        if (project.teamMembers) {
                            Object.values(project.teamMembers).forEach(member => {
                                html += `<li>${member.name ? member.name + ' - ' : ''}${member.email}</li>`;
                            });
                        } else {
                            html += '<li>No team members</li>';
                        }
                        html += '</ul></div>';
                        // Budget Deductions
                        html += `<div style='margin-top:16px;'><strong>Budget Deductions:</strong>`;
                        if (project.budgetHistory) {
                            html += `<table style='width:100%;border-collapse:collapse;margin-top:8px;'>
                                <tr style='background:#f0f0f0;'>
                                    <th style='border:1px solid #ccc;padding:6px;'>Date</th>
                                    <th style='border:1px solid #ccc;padding:6px;'>Budget deducted</th>
                                    <th style='border:1px solid #ccc;padding:6px;'>Purpose</th>
                                    <th style='border:1px solid #ccc;padding:6px;'>Deducted By</th>
                                </tr>`;
                            let hasDeduction = false;
                            Object.values(project.budgetHistory).forEach(bh => {
                                if (bh.deducted) {
                                    hasDeduction = true;
                                    html += `<tr>
                                        <td style='border:1px solid #ccc;padding:6px;'>${bh.date ? new Date(bh.date).toLocaleDateString() : ''}</td>
                                        <td style='border:1px solid #ccc;padding:6px;'>₱${bh.deducted}</td>
                                        <td style='border:1px solid #ccc;padding:6px;'>${bh.purpose || ''}</td>
                                        <td style='border:1px solid #ccc;padding:6px;'>${bh.deductedBy || ''}</td>
                                    </tr>`;
                                }
                            });
                            if (!hasDeduction) {
                                html += `<tr><td colspan='4' style='text-align:center; color:#888;'>No deductions yet.</td></tr>`;
                            }
                            html += '</table>';
                        } else {
                            html += '<div style="color:#888;">No deductions yet.</div>';
                        }
                        html += '</div>';
                        // Files
                        html += `<div style='margin-top:16px;'><strong>Uploaded Files:</strong><div id='archiveFilesList' style='margin-top:8px;'></div></div>`;
                        document.getElementById('archiveProjectTitle').textContent = project.name || 'Untitled Project';
                        document.getElementById('archiveProjectDetails').innerHTML = html;
                        // Now load files from /projects/{userKey}/{projectId}/files
                        const filesListDiv = document.getElementById('archiveFilesList');
                        filesListDiv.innerHTML = '<div style="color:#888;">Loading files...</div>';
                        firebase.database().ref(`projects/${userKey}/${projectId}/files`).once('value')
                            .then((filesSnap) => {
                                if (!filesSnap.exists()) {
                                    filesListDiv.innerHTML = '<div style="color:#888;">No files uploaded yet.</div>';
                                    return;
                                }
                                let filesHtml = '<div style="display: grid; gap: 12px;">';
                                filesSnap.forEach((fileSnap) => {
                                    const file = fileSnap.val();
                                    const fileSize = file.size ? (Math.round((file.size/1024)*10)/10) + ' KB' : '';
                                    const uploadDate = file.uploadedAt ? new Date(file.uploadedAt).toLocaleString() : '';
                                    filesHtml += `
                                        <div style="background: #f8f8f8; border: 1px solid #eee; border-radius: 8px; padding: 10px 14px; display: flex; align-items: center; gap: 14px;">
                                            <div style="font-size: 22px; color: #1976d2; margin-right: 8px;"><i class='fas fa-file-alt'></i></div>
                                            <div style="flex:1; min-width:0;">
                                                <div style="font-weight: 500; color: #222; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${file.name}</div>
                                                <div style="font-size: 13px; color: #888;">${fileSize}${uploadDate ? ' &middot; ' + uploadDate : ''}</div>
                                            </div>
                                            <a href="${file.url || file.data}" download="${file.name}" target="_blank" style="background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 14px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: background 0.2s;">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        </div>
                                    `;
                                });
                                filesHtml += '</div>';
                                filesListDiv.innerHTML = filesHtml;
                            })
                            .catch((error) => {
                                filesListDiv.innerHTML = '<div style="color:#d32f2f;">Error loading files</div>';
                            });
                    })
                    .catch(error => {
                        document.getElementById('archiveProjectDetails').innerHTML = '<div style="color:#d32f2f;">Error loading project details.</div>';
                    });
            });
        }
        // ... existing code ...
        function closeArchiveProjectViewModal() {
            document.getElementById('archiveProjectViewModal').style.display = 'none';
        }
        // ... existing code ...

        function loadRecycleBin() {
            const recycleBinList = document.getElementById('recycleBinList');
            const recycleBinEmpty = document.getElementById('recycleBinEmpty');
            recycleBinList.innerHTML = '';
            recycleBinEmpty.style.display = 'none';
            const email = document.getElementById('sidebarUserEmail').textContent;
            getUserKeyByEmail(email, function(userKey) {
                if (!userKey) {
                    recycleBinEmpty.style.display = 'block';
                    return;
                }
                firebase.database().ref('recycle_bin/' + userKey).once('value')
                    .then(snapshot => {
                        const projects = [];
                        snapshot.forEach(childSnap => {
                            const project = childSnap.val();
                            project._id = childSnap.key;
                            projects.push(project);
                        });
                        if (projects.length === 0) {
                            recycleBinEmpty.style.display = 'block';
                            return;
                        }
                        projects.sort((a, b) => (b.deletedAt || 0) - (a.deletedAt || 0));
                        projects.forEach(project => {
                            const card = document.createElement('div');
                            card.style.background = '#fff';
                            card.style.border = '1px solid #ddd';
                            card.style.borderRadius = '8px';
                            card.style.padding = '20px';
                            card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                            card.innerHTML = `
                                <div style="margin-bottom: 16px;">
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${project.name || 'Untitled Project'}</h3>
                                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">${project.description || 'No description'}</p>
                                </div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Type:</strong> ${project.type || 'Not specified'}</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 4px;"><strong>Deleted:</strong> ${project.deletedAt ? new Date(project.deletedAt).toLocaleDateString() : 'Not specified'}</div>
                                <button onclick="restoreProject('${project._id}', '${userKey}')" style="background: #388e3c; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; margin-right: 8px; cursor: pointer;">Restore</button>
                                <button onclick="permanentlyDeleteProject('${project._id}', '${userKey}')" style="background: #d32f2f; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer;">Delete Permanently</button>
                            `;
                            recycleBinList.appendChild(card);
                        });
                    })
                    .catch(error => {
                        recycleBinEmpty.textContent = 'Error loading recycle bin. Please try again.';
                        recycleBinEmpty.style.display = 'block';
                    });
            });
        }
        function restoreProject(projectId, userKey) {
            if (!confirm('Restore this project?')) return;
            const recycleRef = firebase.database().ref(`recycle_bin/${userKey}/${projectId}`);
            recycleRef.once('value').then(snapshot => {
                const projectData = snapshot.val();
                if (!projectData) {
                    alert('Project not found in recycle bin.');
                    return;
                }
                // Remove deletedAt before restoring
                delete projectData.deletedAt;
                firebase.database().ref(`projects/${userKey}/${projectId}`).set(projectData)
                    .then(() => recycleRef.remove())
                    .then(() => {
                        loadRecycleBin();
                        fetchAndRenderProjects(userKey);
                        updateDashboardSummary();
                        alert('Project restored.');
                    })
                    .catch(error => alert('Error restoring project: ' + error.message));
            });
        }
        function permanentlyDeleteProject(projectId, userKey) {
            if (!confirm('Permanently delete this project? This cannot be undone.')) return;
            firebase.database().ref(`recycle_bin/${userKey}/${projectId}`).remove()
                .then(() => {
                    loadRecycleBin();
                    alert('Project permanently deleted.');
                })
                .catch(error => alert('Error deleting project: ' + error.message));
        }
    </script>

    <!-- Add this after the existing script tags -->
    <script>
        // Add event listener for name change
        document.getElementById('saveNameBtn').addEventListener('click', function() {
            const nameInput = document.getElementById('displayNameInput');
            const nameSpinner = document.getElementById('saveNameSpinner');
            const nameMsg = document.getElementById('saveNameMsg');
            const newName = nameInput.value.trim();
            if (!newName) {
                nameMsg.textContent = 'Please enter a name';
                nameMsg.style.color = '#d32f2f';
                return;
            }
            nameSpinner.style.display = 'inline-block';
            nameMsg.textContent = '';
            // Get current user
            const user = firebase.auth().currentUser;
            if (user) {
                // Update in Firebase Auth
                user.updateProfile({ displayName: newName }).then(() => {
                    // Update in Firebase Database
                    return firebase.database().ref('users/' + user.uid).update({ name: newName });
                }).then(() => {
                    localStorage.setItem('userName', newName);
                    document.getElementById('sidebarUserName').textContent = newName;
                    nameMsg.textContent = 'Name updated successfully';
                    nameMsg.style.color = '#388e3c';
                    nameSpinner.style.display = 'none';
                    // Optionally, refresh members list if visible
                    if (document.getElementById('members-content').style.display !== 'none') {
                        loadCompanyMembers();
                    }
                }).catch((error) => {
                    console.error('Error updating name:', error);
                    nameMsg.textContent = 'Error updating name';
                    nameMsg.style.color = '#d32f2f';
                    nameSpinner.style.display = 'none';
                });
            } else {
                // If no Firebase user, just update localStorage
                localStorage.setItem('userName', newName);
                document.getElementById('sidebarUserName').textContent = newName;
                nameMsg.textContent = 'Name updated successfully';
                nameMsg.style.color = '#388e3c';
                nameSpinner.style.display = 'none';
            }
        });

        // Load current name when settings are opened
        document.getElementById('settingsBtn').addEventListener('click', function() {
            const nameInput = document.getElementById('displayNameInput');
            const currentName = localStorage.getItem('adminName') || 'Admin';
            nameInput.value = currentName;
        });

        // Load admin name when page loads
        window.addEventListener('load', function() {
            const adminName = localStorage.getItem('adminName') || 'Admin';
            document.getElementById('sidebarUserName').textContent = adminName;
        });
    </script>
</body>
</html>